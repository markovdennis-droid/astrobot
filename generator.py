#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import random
import datetime
from typing import Optional

from history import get_recent_template_ids, remember_template_id

# –°–ø–∏—Å–æ–∫ –∑–Ω–∞–∫–æ–≤ –∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –±–æ—Ç–µ (–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∫–ª—é—á–∏)
SIGNS = [
    "aries", "taurus", "gemini", "cancer", "leo", "virgo",
    "libra", "scorpio", "sagittarius", "capricorn", "aquarius", "pisces",
]

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–æ–Ω—è—Ç–Ω—ã–µ —Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
RU_SIGNS = {
    "aries": "‚ôà –û–≤–µ–Ω",
    "taurus": "‚ôâ –¢–µ–ª–µ—Ü",
    "gemini": "‚ôä –ë–ª–∏–∑–Ω–µ—Ü—ã",
    "cancer": "‚ôã –†–∞–∫",
    "leo": "‚ôå –õ–µ–≤",
    "virgo": "‚ôç –î–µ–≤–∞",
    "libra": "‚ôé –í–µ—Å—ã",
    "scorpio": "‚ôè –°–∫–æ—Ä–ø–∏–æ–Ω",
    "sagittarius": "‚ôê –°—Ç—Ä–µ–ª–µ—Ü",
    "capricorn": "‚ôë –ö–æ–∑–µ—Ä–æ–≥",
    "aquarius": "‚ôí –í–æ–¥–æ–ª–µ–π",
    "pisces": "‚ôì –†—ã–±—ã",
}

STYLES = {
    "classic": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π",
    "humor": "–Æ–º–æ—Ä–Ω–æ–π",
    "mystic": "–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π",
    "motivation": "–ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π",
}

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä–∞ ---


def choose_with_antirepeat(sign: str, pool: list, category: str, days: int = 14):
    """
    –í—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ pool —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è
    –¥–ª—è –∑–Ω–∞–∫–∞ `sign` –≤ —Ç–µ—á–µ–Ω–∏–µ `days` –¥–Ω–µ–π.
    category ‚Äî —Å—Ç—Ä–æ–∫–∞, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å ID —à–∞–±–ª–æ–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: "love", "work", "money".
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∞–º —Ç–µ–∫—Å—Ç (—ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞).
    """
    if not pool:
        return None

    # –ü–æ–ª—É—á–∞–µ–º ID-—à–Ω–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ days –¥–Ω–µ–π
    recent_ids = get_recent_template_ids(sign, days=days)

    # –ì–æ—Ç–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ (index, value, template_id)
    candidates = []
    for idx, value in enumerate(pool):
        template_id = f"{category}_{idx}"
        if template_id not in recent_ids:
            candidates.append((template_id, value))

    # –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –Ω–µ–¥–∞–≤–Ω–æ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –∏–∑ –Ω–∏—Ö
    if candidates:
        template_id, chosen_value = random.choice(candidates)
    else:
        # –ï—Å–ª–∏ –≤—Å–µ —É–∂–µ –±—ã–ª–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ days ‚Äî –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        # –ø—Ä–æ—Å—Ç–æ –≤—ã–±–∏—Ä–∞–µ–º –ª—é–±–æ–π —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
        idx = random.randrange(len(pool))
        template_id = f"{category}_{idx}"
        chosen_value = pool[idx]

    # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å–µ–≥–æ–¥–Ω—è
    remember_template_id(sign, template_id)

    return chosen_value


# --- –°–µ–∑–æ–Ω—ã –∏ –∏—Ö —Ç–µ–∫—Å—Ç—ã ---


def get_season(date: datetime.date) -> str:
    """–í–µ—Ä–Ω—É—Ç—å —Å–µ–∑–æ–Ω: winter / spring / summer / autumn."""
    m = date.month
    if m in (12, 1, 2):
        return "winter"
    if m in (3, 4, 5):
        return "spring"
    if m in (6, 7, 8):
        return "summer"
    return "autumn"


SEASON_HINTS = {
    "winter": "–∑–∏–º–Ω–∏–π –≤–æ–∑–¥—É—Ö –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ç–∏—à–∏–Ω—ã",
    "spring": "–≤–µ—Å–µ–Ω–Ω—è—è —ç–Ω–µ—Ä–≥–∏—è –ø–æ–º–æ–≥–∞–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –∏ –ª–µ–≥—á–µ –∏–¥—Ç–∏ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä",
    "summer": "–ª–µ—Ç–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —É—Å–∏–ª–∏–≤–∞–µ—Ç —ç–º–æ—Ü–∏–∏ –∏ —Ç—è–≥—É –∫ –æ–±—â–µ–Ω–∏—é",
    "autumn": "–æ—Å–µ–Ω–Ω—è—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –Ω–∞ –∞–Ω–∞–ª–∏–∑, –≤—ã–≤–æ–¥—ã –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ —à–∞–≥–∏",
}

SEASON_COLORS = {
    "winter": ["–≥–ª—É–±–æ–∫–∏–π —Å–∏–Ω–∏–π", "—Å–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π", "—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π"],
    "spring": ["–Ω–µ–∂–Ω–æ-–∑–µ–ª—ë–Ω—ã–π", "–ª–∞–π–º–æ–≤—ã–π", "–Ω–µ–±–µ—Å–Ω–æ-–≥–æ–ª—É–±–æ–π"],
    "summer": ["—è–Ω—Ç–∞—Ä–Ω—ã–π", "–∑–æ–ª–æ—Ç–∏—Å—Ç—ã–π", "–∫–æ—Ä–∞–ª–ª–æ–≤—ã–π"],
    "autumn": ["–±–æ—Ä–¥–æ–≤—ã–π", "—Ç–µ—Ä—Ä–∞–∫–æ—Ç–æ–≤—ã–π", "–æ–ª–∏–≤–∫–æ–≤—ã–π"],
}

# --- –¢–æ–Ω –¥–Ω—è: —Å–∏–ª—å–Ω—ã–π / –ª—ë–≥–∫–∏–π / –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π ---


DAY_TONES = {
    "strong": {
        "label": "–°–∏–ª—å–Ω—ã–π –¥–µ–Ω—å",
        "descriptions": [
            "–î–µ–Ω—å –¥–∞—ë—Ç –º–æ—â–Ω—ã–π –∏–º–ø—É–ª—å—Å ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–¥–∞–≤–ª–∏–≤–∞—Ç—å —Å–≤–æ–∏ —Ä–µ—à–µ–Ω–∏—è –∏ –±—Ä–∞—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É.",
            "–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è –ø–ª–æ—Ç–Ω–∞—è –∏ —Å–æ–±—Ä–∞–Ω–Ω–∞—è: –ª–µ–≥–∫–æ –∑–∞–≤–µ—Ä—à–∞—Ç—å –Ω–∞—á–∞—Ç–æ–µ –∏ —Å—Ç–∞–≤–∏—Ç—å –∂—ë—Å—Ç–∫–∏–µ —Ä–∞–º–∫–∏.",
            "–≠—Ç–æ –¥–µ–Ω—å –¥–ª—è —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –º–µ–Ω—å—à–µ —Å–æ–º–Ω–µ–Ω–∏–π, –±–æ–ª—å—à–µ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π.",
        ],
    },
    "light": {
        "label": "–õ—ë–≥–∫–∏–π –¥–µ–Ω—å",
        "descriptions": [
            "–î–µ–Ω—å –º—è–≥–∫–∏–π –∏ –ª—ë–≥–∫–∏–π ‚Äî —Ö–æ—Ä–æ—à–æ –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å—Å—è, –æ–±—â–∞—Ç—å—Å—è –∏ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –º–µ–ª–∫–∏–µ –¥–µ–ª–∞.",
            "–§–æ–Ω –¥–Ω—è —Å–ø–æ–∫–æ–π–Ω—ã–π: –≤—Å—ë –ø–æ–ª—É—á–∞–µ—Ç—Å—è –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ —Ç–æ—Ä–æ–ø–∏—Ç—å —Å–æ–±—ã—Ç–∏—è.",
            "–ù–µ–ø–ª–æ—Ö–æ–π –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –æ—Ç–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏—è–º —Ç–µ—á—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.",
        ],
    },
    "harmonious": {
        "label": "–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å",
        "descriptions": [
            "–î–µ–Ω—å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–∫–æ—Å—ã ‚Äî –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã –∏ —Ç–æ—á–∫–∏ –±–∞–ª–∞–Ω—Å–∞.",
            "–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏–º–∏—Ä–∏—Ç—å—Å—è, –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –∏ —Å–¥–µ–ª–∞—Ç—å —à–∞–≥ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≥–∞—Ä–º–æ–Ω–∏–∏.",
            "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Å —Å–æ–±–æ–π –∏ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö, –Ω–æ –≤–∞–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π.",
        ],
    },
}

# --- –ü—É–ª—ã —Ç–µ–∫—Å—Ç–æ–≤ –ø–æ —Å—Ñ–µ—Ä–∞–º ---


LOVE_TEXTS = {
    "strong": [
        "–í –ª–∏—á–Ω–æ–π –∂–∏–∑–Ω–∏ –º–æ–∂–Ω–æ –æ–±–æ–∑–Ω–∞—á–∏—Ç—å —Å–≤–æ–∏ –≥—Ä–∞–Ω–∏—Ü—ã —è—Å–Ω–µ–µ ‚Äî –ø–∞—Ä—Ç–Ω—ë—Ä —É—Å–ª—ã—à–∏—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–Ω–∞—á–∞–ª–∞ —É–¥–∏–≤–∏—Ç—Å—è.",
        "–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Ç—è–Ω—É—Ç—å –ø—Ä–æ—à–ª–æ–µ –≤ –±—É–¥—É—â–µ–µ –∏ —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∑–∞—Ç—å, —á–µ–≥–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.",
        "–ï—Å–ª–∏ —Ä–µ—à–∏—Ç–µ—Å—å –Ω–∞ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä, –æ–Ω –º–æ–∂–µ—Ç –º–Ω–æ–≥–æ–µ —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –ø–æ –º–µ—Å—Ç–∞–º –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –Ω–æ–≤–æ–º—É.",
    ],
    "light": [
        "–í –ª—é–±–≤–∏ –ø–æ–¥–æ–π–¥—É—Ç –ª—ë–≥–∫–∏–µ –∂–µ—Å—Ç—ã –≤–Ω–∏–º–∞–Ω–∏—è: —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç, –º–∞–ª–µ–Ω—å–∫–∏–π —Å—é—Ä–ø—Ä–∏–∑.",
        "–ù–µ –¥–∞–≤–∏—Ç–µ –Ω–∞ —Å–µ—Ä—å—ë–∑–Ω—ã–µ —Ç–µ–º—ã ‚Äî –¥–∞–π—Ç–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º —á—É—Ç—å –±–æ–ª—å—à–µ –≤–æ–∑–¥—É—Ö–∞ –∏ —Å–≤–æ–±–æ–¥—ã.",
        "–õ—É—á—à–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏ –≤—ã—Å–ª—É—à–∞—Ç—å, —á–µ–º –ø—ã—Ç–∞—Ç—å—Å—è –≤—Å—ë –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏.",
    ],
    "harmonious": [
        "–î–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç —É—Å–ª—ã—à–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞: –≤–∞–∂–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å –º—è–≥–∫–æ, –Ω–æ –ø–æ —Å—É—â–µ—Å—Ç–≤—É.",
        "–ú–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É –≤–∞—à–∏–º —Ä–∏—Ç–º–æ–º –∏ –æ–∂–∏–¥–∞–Ω–∏—è–º–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
        "–ü–æ–ª–µ–∑–Ω–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å, –∑–∞ —á—Ç–æ –≤—ã —Ü–µ–Ω–∏—Ç–µ –±–ª–∏–∑–∫–∏—Ö ‚Äî –∏ –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–µ–ª–æ—á–∞—Ö.",
    ],
}

WORK_TEXTS = {
    "strong": [
        "–ü–æ —Ä–∞–±–æ—Ç–µ —Å—Ç–æ–∏—Ç –±—Ä–∞—Ç—å —Ç–æ, —á—Ç–æ –¥–∞–≤–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–ª–∏ ‚Äî —Å–µ–π—á–∞—Å –ø—Ä–æ—â–µ –¥–æ–∂–∞—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É.",
        "–ú–æ–∂–Ω–æ –ø—Ä–æ—è–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —Ä–µ—à–µ–Ω–∏—è ‚Äî –∫ –Ω–µ–º—É –æ—Ç–Ω–µ—Å—É—Ç—Å—è —Å–µ—Ä—å—ë–∑–Ω–æ.",
        "–ñ—ë—Å—Ç–∫–∏–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –ø—Ä–æ–π–¥—É—Ç –ª—É—á—à–µ, –µ—Å–ª–∏ –∑–∞—Ä–∞–Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è —Å–µ–±—è –≥—Ä–∞–Ω–∏—Ü—ã –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ.",
    ],
    "light": [
        "–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –¥–µ–ª, –ø–µ—Ä–µ–ø–∏—Å–æ–∫ –∏ –º–µ–ª–∫–∏—Ö –∑–∞–¥–∞—á –±–µ–∑ —Å–∏–ª—å–Ω–æ–≥–æ –Ω–∞–ø—Ä—è–≥–∞.",
        "–ú–æ–∂–Ω–æ —É—á–∏—Ç—å—Å—è –Ω–æ–≤–æ–º—É –∏–ª–∏ —Å–ø–æ–∫–æ–π–Ω–æ —Ä–∞–∑–±–∏—Ä–∞—Ç—å –∑–∞–≤–∞–ª—ã ‚Äî –±–µ–∑ –≥–µ—Ä–æ–∏–∑–º–∞ –∏ –ø–µ—Ä–µ–≥—Ä—É–∑–æ–∫.",
        "–ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≥–Ω–∞—Ç—å—Å—è –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º ‚Äî –æ—Ç–º–µ—Ç—å—Ç–µ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –∏ –Ω–µ –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–π—Ç–µ –∏—Ö.",
    ],
    "harmonious": [
        "–°—Ç–æ–∏—Ç –≤—ã—Ä–æ–≤–Ω—è—Ç—å —Ä–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã: —É–±—Ä–∞—Ç—å –ª–∏—à–Ω–µ–µ, —É–ø—Ä–æ—Å—Ç–∏—Ç—å, –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è –æ –ø–æ–Ω—è—Ç–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª–∞—Ö.",
        "–ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ —Å –∫–æ–ª–ª–µ–≥–∞–º–∏, –¥–µ–Ω—å –¥–∞—ë—Ç —à–∞–Ω—Å –º—è–≥–∫–æ —Å–Ω–∏–∑–∏—Ç—å –≥—Ä–∞–¥—É—Å –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –¥–µ–ª—É.",
        "–ü–æ–ª–µ–∑–Ω–æ —Å–æ–æ—Ç–Ω–µ—Å—Ç–∏ —Å–≤–æ–∏ –ø–ª–∞–Ω—ã —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é ‚Äî –Ω–µ –∏–∑ –∂—ë—Å—Ç–∫–æ–π –∫—Ä–∏—Ç–∏–∫–∏, –∞ –∏–∑ –∑–∞–±–æ—Ç—ã –æ —Å–µ–±–µ.",
    ],
}

MONEY_TEXTS = {
    "strong": [
        "–° —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –ª—É—á—à–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ: –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–∞—Ç—ã, –Ω–∞–º–µ—Ç–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏.",
        "–ú–æ–∂–Ω–æ —Å–º–µ–ª–µ–µ –æ–±—Å—É–∂–¥–∞—Ç—å –¥–µ–Ω—å–≥–∏ –∏ —É—Å–ª–æ–≤–∏—è ‚Äî –≤–∞–∂–Ω–∞ —è—Å–Ω–æ—Å—Ç—å, –∞ –Ω–µ —É–≥–∞–¥—ã–≤–∞–Ω–∏—è.",
    ],
    "light": [
        "–ü–æ–¥–æ–π–¥—É—Ç –Ω–µ–±–æ–ª—å—à–∏–µ, –Ω–æ –ø—Ä–∏—è—Ç–Ω—ã–µ —Ç—Ä–∞—Ç—ã –Ω–∞ –∫–æ–º—Ñ–æ—Ä—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.",
        "–ù–µ –ª—É—á—à–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã—Ö —à–∞–≥–æ–≤ ‚Äî –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å —Å–µ–π—á–∞—Å –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏.",
    ],
    "harmonious": [
        "–°—Ç–æ–∏—Ç –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –ø–ª–∞—Ç–µ–∂–∞—Ö –∏ –ø–æ–¥–ø–∏—Å–∫–∞—Ö, —á—Ç–æ–±—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è.",
        "–ü–æ–ª–µ–∑–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è —Å –±–ª–∏–∑–∫–∏–º–∏ –∏ —Å–Ω—è—Ç—å –ª–∏—à–Ω–∏–µ –Ω–µ–¥–æ–º–æ–ª–≤–∫–∏.",
    ],
}

HEALTH_TEXTS = {
    "strong": [
        "–¢–µ–ª—É –ø–æ–ª–µ–∑–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –Ω–æ –±–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞: –ª—É—á—à–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏, —á–µ–º —Ä—ã–≤–∫–∏.",
        "–•–æ—Ä–æ—à–æ –∑–∞—Ö–æ–¥—è—Ç —á—ë—Ç–∫–∏–µ —Ä–µ–∂–∏–º—ã: —Å–æ–Ω, –ø–∏—Ç–∞–Ω–∏–µ –∏ –≤–æ–¥–∞ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.",
    ],
    "light": [
        "–ü–æ–¥–æ–π–¥—É—Ç –ø—Ä–æ–≥—É–ª–∫–∏, —Ä–∞—Å—Ç—è–∂–∫–∞, –º—è–≥–∫–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è —Ç–µ–ª–∞ –∏ –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.",
        "–ù–µ –∑–∞–≥–æ–Ω—è–π—Ç–µ —Å–µ–±—è –≤ –∂—ë—Å—Ç–∫–∏–µ —Ä–∞–º–∫–∏ ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ —Ç–æ, —á—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç, –∞ –Ω–µ –∏—Å—Ç–æ—â–∞–µ—Ç.",
    ],
    "harmonious": [
        "–ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è –∫ —Ç–µ–ª—É –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å—Å—è –Ω–∞ —Å–ø–æ–∫–æ–π–Ω—ã–π, –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º.",
        "–î–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∑–∞–±–æ—Ç—ã –æ –Ω–µ—Ä–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ: –º–µ–Ω—å—à–µ –∏–Ω—Ñ–æ—à—É–º–∞, –±–æ–ª—å—à–µ —Ç–∏—à–∏–Ω—ã.",
    ],
}

GENERAL_TIPS = [
    "–¥–µ–ª–∞–π—Ç–µ –ø–∞—É–∑—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –Ω–µ—Ç –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–∏",
    "—Å–Ω–∞—á–∞–ª–∞ —É—Ç–æ—á–Ω–∏—Ç–µ —Ñ–∞–∫—Ç—ã, –∞ —É–∂–µ –ø–æ—Ç–æ–º –¥–µ–ª–∞–π—Ç–µ –≤—ã–≤–æ–¥—ã",
    "—Å–Ω–∏–∂–∞–π—Ç–µ –ø–ª–∞–Ω–∫—É –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–∞ —Ö–æ—Ç—è –±—ã –Ω–∞ –æ–¥–∏–Ω —à–∞–≥",
    "–¥–µ–ª–∞–π—Ç–µ –ø–æ –æ–¥–Ω–æ–º—É —à–∞–≥—É –∑–∞ —Ä–∞–∑, –Ω–µ –ø—ã—Ç–∞—è—Å—å —Ä–µ—à–∏—Ç—å –≤—Å—ë —Å–µ–≥–æ–¥–Ω—è",
    "–ø–∏—à–∏—Ç–µ –≤–∞–∂–Ω—ã–µ –º—ã—Å–ª–∏ –∏ –∑–∞–¥–∞—á–∏ ‚Äî –Ω–µ –¥–µ—Ä–∂–∏—Ç–µ –≤—Å—ë —Ç–æ–ª—å–∫–æ –≤ –≥–æ–ª–æ–≤–µ",
]


def _format_date_for_header(dt: Optional[str]) -> (datetime.date, str):
    """–ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏–∑ —Å—Ç—Ä–æ–∫–∏ –∏ –≥–æ—Ç–æ–≤–∏–º –ø–æ–¥–ø–∏—Å—å –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫."""
    if dt:
        try:
            date_obj = datetime.date.fromisoformat(dt)
        except ValueError:
            date_obj = datetime.date.today()
    else:
        date_obj = datetime.date.today()

    if dt:
        when = f"–Ω–∞ –¥–∞—Ç—É {date_obj.strftime('%d.%m.%Y')}"
    else:
        when = "—Å–µ–≥–æ–¥–Ω—è"

    return date_obj, when


def generate(sign: str, style: str = "classic", lang: str = "ru", dt: Optional[str] = None) -> str:
    """
    –û—Å–Ω–æ–≤–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≥–æ—Ä–æ—Å–∫–æ–ø–∞:
    - –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä—ã –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º –Ω–∞ 14 –¥–Ω–µ–π
    - —Å–µ–∑–æ–Ω–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏
    - –ª–æ–≥–∏–∫–∞ —Å–∏–ª—å–Ω—ã–π/–ª—ë–≥–∫–∏–π/–≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å
    - —Ä–∞–∑–Ω—ã–µ –±–ª–æ–∫–∏: –æ–±—â–∏–π —Ñ–æ–Ω, –ª—é–±–æ–≤—å, —Ä–∞–±–æ—Ç–∞, –¥–µ–Ω—å–≥–∏, –∑–¥–æ—Ä–æ–≤—å–µ, —Å–æ–≤–µ—Ç, —á–∏—Å–ª–∞/—Ü–≤–µ—Ç.
    """
    # –ü–æ–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ RU
    if lang != "ru":
        lang = "ru"

    sign_key = (sign or "").lower()
    if sign_key not in SIGNS:
        sign_key = "aries"

    sign_label = RU_SIGNS.get(sign_key, sign_key.title())

    date_obj, when = _format_date_for_header(dt)
    season = get_season(date_obj)
    season_hint = SEASON_HINTS.get(season, "")
    season_color = random.choice(SEASON_COLORS.get(season, ["–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç"]))

    # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–Ω –¥–Ω—è
    tone_key = random.choices(
        population=["strong", "light", "harmonious"],
        weights=[0.4, 0.3, 0.3],
        k=1,
    )[0]
    tone_block = DAY_TONES[tone_key]
    tone_label = tone_block["label"]
    tone_text = choose_with_antirepeat(sign_label, tone_block["descriptions"], f"tone_{tone_key}")

    # –û—Ç–∫—Ä—ã–≤–∞—é—â–∞—è —Ñ—Ä–∞–∑–∞ –ø–æ —Å—Ç–∏–ª—é
    style_openers = {
        "classic": [
            "–î–µ–Ω—å —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ —Ü–µ–ª–æ–º –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ.",
            "–ù–∞—Å—Ç—É–ø–∞—é—â–∏–µ —á–∞—Å—ã –Ω–µ—Å—É—Ç –ø–æ–Ω—è—Ç–Ω—É—é, —Ä–∞–±–æ—á—É—é —ç–Ω–µ—Ä–≥–∏—é.",
            "–°–µ–≥–æ–¥–Ω—è –≤–∞–∂–Ω–æ –Ω–µ —Å–ø–µ—à–∏—Ç—å —Å –≤—ã–≤–æ–¥–∞–º–∏, –Ω–æ –±—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º –∫ –¥–µ—Ç–∞–ª—è–º.",
        ],
        "humor": [
            "–í—Å–µ–ª–µ–Ω–Ω–∞—è —Å–ª–µ–≥–∫–∞ –ø–æ–¥–º–∏–≥–Ω—É–ª–∞ ‚Äî –º–æ–∂–Ω–æ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–æ –±–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞.",
            "–ó–≤—ë–∑–¥—ã —Å–µ–≥–æ–¥–Ω—è –Ω–µ –ø—Ä–æ—Ç–∏–≤ –≤–∞—à–∏—Ö –ø–ª–∞–Ω–æ–≤, –Ω–æ –ø—Ä–æ—Å—è—Ç –±–µ–∑ –¥—Ä–∞–º.",
            "–ö–æ—Å–º–æ—Å –∫–∞–∫ –±—ã –≥–æ–≤–æ—Ä–∏—Ç: ¬´—Å–¥–µ–ª–∞–π, —á—Ç–æ –º–æ–∂–µ—à—å, –∏ –Ω–µ –º—É—á–∞–π —Å–µ–±—è –ª–∏—à–Ω–∏–º¬ª.",
        ],
        "mystic": [
            "–ò–Ω—Ç—É–∏—Ü–∏—è —Å–µ–≥–æ–¥–Ω—è –∑–≤—É—á–∏—Ç –≥—Ä–æ–º—á–µ –æ–±—ã—á–Ω–æ–≥–æ ‚Äî –∫ –Ω–µ–π —Å—Ç–æ–∏—Ç –ø—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è.",
            "–ó–Ω–∞–∫–∏ –∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å —á—É—Ç—å –∑–∞–º–µ—Ç–Ω–µ–µ ‚Äî –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —Ç–æ–Ω–∫–∏–µ –Ω–∞–º—ë–∫–∏.",
            "–°–Ω—ã, –æ–±—Ä–∞–∑—ã –∏ –æ—â—É—â–µ–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å —Ç–æ, –æ —á—ë–º –≤—ã –¥–∞–≤–Ω–æ –¥—É–º–∞–µ—Ç–µ.",
        ],
        "motivation": [
            "–°–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥ –∫ –¥–∞–≤–Ω–æ –Ω–∞–∑—Ä–µ–≤—à–µ–π —Ü–µ–ª–∏.",
            "–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã—Ç–∞—â–∏—Ç—å —Ç–æ, —á—Ç–æ –≤—ã –æ—Ç–∫–ª–∞–¥—ã–≤–∞–ª–∏, –∏ —Ö–æ—Ç—è –±—ã –Ω–∞—á–∞—Ç—å.",
            "–ï—Å–ª–∏ –¥–∞–≤–Ω–æ —Å–æ–±–∏—Ä–∞–ª–∏—Å—å –æ —Å–µ–±–µ –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è ‚Äî —Å–∞–º–æ–µ –≤—Ä–µ–º—è —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —Å–µ–≥–æ–¥–Ω—è.",
        ],
    }
    opener_pool = style_openers.get(style, style_openers["classic"])
    opener = choose_with_antirepeat(sign_label, opener_pool, f"open_{style}")

    # –°—Ñ–µ—Ä—ã
    love = choose_with_antirepeat(sign_label, LOVE_TEXTS[tone_key], f"love_{tone_key}")
    work = choose_with_antirepeat(sign_label, WORK_TEXTS[tone_key], f"work_{tone_key}")
    money = choose_with_antirepeat(sign_label, MONEY_TEXTS[tone_key], f"money_{tone_key}")
    health = choose_with_antirepeat(sign_label, HEALTH_TEXTS[tone_key], f"health_{tone_key}")
    tip = choose_with_antirepeat(sign_label, GENERAL_TIPS, "tip_general")

    lucky_number = random.randint(1, 99)

    header = f"{sign_label} ‚Äî {STYLES.get(style, '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π')} –≥–æ—Ä–æ—Å–∫–æ–ø | {when}"
    line_tone = f"üéØ –û–±—â–∏–π —Ñ–æ–Ω: {tone_label}. {tone_text}"
    line_season = f"üåø –û—Ç—Ç–µ–Ω–æ–∫ –¥–Ω—è: {season_hint}."
    line_love = f"üíñ –õ—é–±–æ–≤—å: {love}"
    line_work = f"üíº –†–∞–±–æ—Ç–∞: {work}"
    line_money = f"üí∞ –î–µ–Ω—å–≥–∏: {money}"
    line_health = f"üåø –ó–¥–æ—Ä–æ–≤—å–µ: {health}"
    line_tip = f"‚ú® –°–æ–≤–µ—Ç –¥–Ω—è: {tip}."
    line_meta = f"üî¢ –ß–∏—Å–ª–æ –¥–Ω—è: {lucky_number} | üé® –¶–≤–µ—Ç –¥–Ω—è: {season_color}."

    body = "\n".join(
        [
            opener,
            line_tone,
            line_season,
            "",
            line_love,
            line_work,
            line_money,
            line_health,
            "",
            line_tip,
            line_meta,
        ]
    )

    return f"{header}\n\n{body}"
