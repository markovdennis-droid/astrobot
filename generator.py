import json
import random
from datetime import datetime, date
from pathlib import Path
from typing import Dict, Any, List

import pytz

BASE_DIR = Path(__file__).parent
ASTRO_STATE_FILE = BASE_DIR / "astro_state.json"

# –¢–∞–π–º–∑–æ–Ω–∞ (–ò—Å–ø–∞–Ω–∏—è)
TZ = pytz.timezone("Europe/Madrid")

ZODIAC_SIGNS = [
    "–û–≤–µ–Ω",
    "–¢–µ–ª–µ—Ü",
    "–ë–ª–∏–∑–Ω–µ—Ü—ã",
    "–†–∞–∫",
    "–õ–µ–≤",
    "–î–µ–≤–∞",
    "–í–µ—Å—ã",
    "–°–∫–æ—Ä–ø–∏–æ–Ω",
    "–°—Ç—Ä–µ–ª–µ—Ü",
    "–ö–æ–∑–µ—Ä–æ–≥",
    "–í–æ–¥–æ–ª–µ–π",
    "–†—ã–±—ã",
]

DAY_TYPES = [
    "–ª—ë–≥–∫–∏–π –¥–µ–Ω—å",
    "–≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å",
    "–¥–µ–Ω—å —Å–∏–ª—å–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏",
]

SEASONS = {
    "winter": [12, 1, 2],
    "spring": [3, 4, 5],
    "summer": [6, 7, 8],
    "autumn": [9, 10, 11],
}

SEASON_PHRASES = {
    "winter": [
        "–ó–∏–º–Ω—è—è –ø–∞—É–∑–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ç–µ–±–µ —É—Å–ª—ã—à–∞—Ç—å —Å–µ–±—è.",
        "–•–æ–ª–æ–¥ —Å–Ω–∞—Ä—É–∂–∏ ‚Äî –Ω–µ –ø–æ–≤–æ–¥ –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—Ç—å —Å–≤–æ–∏ –º–µ—á—Ç—ã.",
        "–¢—ë–ø–ª—ã–µ –º–µ–ª–æ—á–∏ –¥–Ω—è –≤–∞–∂–Ω–µ–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.",
    ],
    "spring": [
        "–í–µ—Å–Ω–∞ –¥–∞—ë—Ç —à–∞–Ω—Å –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.",
        "–í—Ä–µ–º—è –º—è–≥–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ —Ç–∏—Ö–æ–≥–æ —Ä–æ—Å—Ç–∞.",
        "–ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –º–∞–ª–µ–Ω—å–∫–æ–µ ¬´–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ¬ª –≤ –ø—Ä–∏–≤—ã—á–∫–∞—Ö.",
    ],
    "summer": [
        "–õ–µ—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —è—Ä–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –∏ –∂–∏–≤—ã–µ —ç–º–æ—Ü–∏–∏.",
        "–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –Ω–∞–ø–æ–ª–Ω—è—Ç—å –¥–µ–Ω—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏.",
        "–ü–æ–ª–µ–∑–Ω–æ —É–¥–µ–ª–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–ª—É: –æ—Ç–¥—ã—Ö, –≤–æ–¥–∞, –¥–≤–∏–∂–µ–Ω–∏–µ.",
    ],
    "autumn": [
        "–û—Å–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –º—ã—Å–ª—è—Ö.",
        "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å—Å—è –æ—Ç –ª–∏—à–Ω–µ–≥–æ.",
        "–£—é—Ç–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–¥–≤–µ—Å—Ç–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –∏—Ç–æ–≥–∏.",
    ],
}

LOVE_PHRASES = [
    "–í –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –ø–æ–º–æ–∂–µ—Ç —Å–ø–æ–∫–æ–π–Ω—ã–π, —á–µ—Å—Ç–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä.",
    "–ü–æ–ª–µ–∑–Ω–æ —á—É—Ç—å –º—è–≥—á–µ –æ—Ç–Ω–µ—Å—Ç–∏—Å—å –∫ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞–º ‚Äî —Å–≤–æ–∏–º –∏ —á—É–∂–∏–º.",
    "–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø—Ä–æ—è–≤–∏—Ç—å –∑–∞–±–æ—Ç—É –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å.",
    "–ù–µ–±–æ–ª—å—à–æ–π –∑–Ω–∞–∫ –≤–Ω–∏–º–∞–Ω–∏—è —Å–¥–µ–ª–∞–µ—Ç —á—å–∏-—Ç–æ –≥–ª–∞–∑–∞ —Ç–µ–ø–ª–µ–µ.",
]

WORK_PHRASES = [
    "–ù–∞ —Ä–∞–±–æ—Ç–µ –ª—É—á—à–µ –¥–≤–∏–≥–∞—Ç—å—Å—è —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, –±–µ–∑ —Ä—ã–≤–∫–æ–≤.",
    "–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ –æ–¥–Ω–æ–º –¥–µ–ª–µ ‚Äî —Ç–∞–∫ –±—ã—Å—Ç—Ä–µ–µ —É–≤–∏–¥–∏—à—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
    "–ü–æ–ª–µ–∑–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∏ –Ω–µ —Å—Ç–µ—Å–Ω—è—Ç—å—Å—è –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã.",
    "–°–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —É–ø–æ—Ä –Ω–∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—å, –∞ –Ω–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å.",
]

MONEY_PHRASES = [
    "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –ª—É—á—à–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –±–µ–∑ —Å–ø–µ—à–∫–∏.",
    "–ü–æ–¥—É–º–∞–π, –æ—Ç –∫–∞–∫–∏—Ö –ª–∏—à–Ω–∏—Ö —Ç—Ä–∞—Ç –º–æ–∂–Ω–æ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –±–µ–∑ –ø–æ—Ç–µ—Ä—å.",
    "–ù–µ–±–æ–ª—å—à–∞—è —ç–∫–æ–Ω–æ–º–∏—è —Å–µ–≥–æ–¥–Ω—è –ø–æ–¥–¥–µ—Ä–∂–∏—Ç —Ç–µ–±—è –ø–æ–∑–∂–µ.",
    "–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã.",
]

HEALTH_PHRASES = [
    "–¢–µ–ª–æ —Å–∫–∞–∂–µ—Ç ¬´—Å–ø–∞—Å–∏–±–æ¬ª –∑–∞ –≤–æ–¥—É –∏ —á—É—Ç—å –±–æ–ª—å—à–µ –¥–≤–∏–∂–µ–Ω–∏—è.",
    "–°–æ–Ω –∏ –æ—Ç–¥—ã—Ö –≤–∞–∂–Ω–µ–µ, —á–µ–º –µ—â—ë –æ–¥–∏–Ω —á–∞—Å –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ.",
    "–ü–æ–ª–µ–∑–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É –¥–ª—è –¥—ã—Ö–∞–Ω–∏—è –∏ —Ä–∞—Å—Ç—è–∂–∫–∏.",
    "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç –ø—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è –∫ —Å–∏–≥–Ω–∞–ª–∞–º –æ—Ä–≥–∞–Ω–∏–∑–º–∞.",
]

ADVICE_PHRASES = [
    "–ù–µ –≥–æ–Ω–∏ —Å–æ–±—ã—Ç–∏—è ‚Äî –¥–∞–π –¥–Ω—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å—Å—è —Å–ø–æ–∫–æ–π–Ω–æ.",
    "–í—ã–±–µ—Ä–∏ –æ–¥–Ω–æ –Ω–µ–±–æ–ª—å—à–æ–µ –¥–µ–ª–æ –∏ —Å–¥–µ–ª–∞–π –µ–≥–æ –¥–æ –∫–æ–Ω—Ü–∞.",
    "–°–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —Ö–æ—Ç—å –æ–¥–∏–Ω –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∫ —Ç–æ–º—É, —á—Ç–æ –¥–∞–≤–Ω–æ —Ö–æ—á–µ—à—å.",
    "–ü–æ–º–Ω–∏: —Ç–∏—à–∏–Ω–∞ –∏ –ø–∞—É–∑–∞ —Ç–æ–∂–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–µ—à–µ–Ω–∏–µ–º.",
]

NUMBERS = [1, 2, 3, 4, 5, 7, 8, 9]
COLORS = [
    "—è–Ω—Ç–∞—Ä–Ω—ã–π",
    "–∏–∑—É–º—Ä—É–¥–Ω—ã–π",
    "–Ω–µ–±–µ—Å–Ω–æ-–≥–æ–ª—É–±–æ–π",
    "—Ç–µ—Ä—Ä–∞–∫–æ—Ç–æ–≤—ã–π",
    "–æ–ª–∏–≤–∫–æ–≤—ã–π",
    "–ª–∞–≤–∞–Ω–¥–æ–≤—ã–π",
    "—Å–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π",
    "–∑–æ–ª–æ—Ç–∏—Å—Ç—ã–π",
]

# --- –¢–ê–†–û: —Ç–æ–ª—å–∫–æ —Å–≤–µ—Ç–ª—ã–µ –∫–∞—Ä—Ç—ã ---

TAROT_CARDS: List[Dict[str, str]] = [
    {
        "name": "–®—É—Ç",
        "short": "–Ω–æ–≤—ã–π —à–∞–≥",
        "meaning": "–î–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª—ë–≥–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –∏ —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ—Å—Ç—å, –Ω–æ –±–µ–∑ —Ä–µ–∑–∫–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π."
    },
    {
        "name": "–ú–∞–≥",
        "short": "—Ñ–æ–∫—É—Å –∏ –≤–æ–ª—è",
        "meaning": "–ú–æ–∂–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ –æ–¥–Ω–æ–º –≤–∞–∂–Ω–æ–º –¥–µ–ª–µ –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥."
    },
    {
        "name": "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞",
        "short": "–∑–∞–±–æ—Ç–∞ –∏ —Ä–æ—Å—Ç",
        "meaning": "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ –∏ –±–ª–∏–∑–∫–∏—Ö, –¥–æ–±–∞–≤–∏—Ç—å –≤ –¥–µ–Ω—å –±–æ–ª—å—à–µ —É—é—Ç–∞."
    },
    {
        "name": "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä",
        "short": "—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –æ–ø–æ—Ä–∞",
        "meaning": "–î–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –¥–µ–ª–∞—Ö –∏ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å."
    },
    {
        "name": "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç",
        "short": "–æ–ø—ã—Ç –∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏",
        "meaning": "–ú–æ–∂–Ω–æ –æ–ø–µ—Ä–µ—Ç—å—Å—è –Ω–∞ –∑–Ω–∞–Ω–∏—è, –æ–ø—ã—Ç –∏–ª–∏ —Å–æ–≤–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É –¥–æ–≤–µ—Ä—è–µ—à—å."
    },
    {
        "name": "–í–ª—é–±–ª—ë–Ω–Ω—ã–µ",
        "short": "–≤—ã–±–æ—Ä —Å–µ—Ä–¥—Ü–µ–º",
        "meaning": "–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –ø—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è –∫ —Ç–æ–º—É, —á—Ç–æ –¥–ª—è —Ç–µ–±—è –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –≤–∞–∂–Ω–æ."
    },
    {
        "name": "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞",
        "short": "–¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥",
        "meaning": "–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è –ø–æ–º–æ–≥–∞–µ—Ç —Å–¥–µ–ª–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–π, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω—ã–π —à–∞–≥ –∫ —Ü–µ–ª–∏."
    },
    {
        "name": "–°–∏–ª–∞",
        "short": "–º—è–≥–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å",
        "meaning": "–°–ø–æ–∫–æ–π–Ω–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏–ª–∞ –æ–∫–∞–∂–µ—Ç—Å—è –ø–æ–ª–µ–∑–Ω–µ–µ, —á–µ–º –∂—ë—Å—Ç–∫–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ."
    },
    {
        "name": "–ó–≤–µ–∑–¥–∞",
        "short": "—Ç–∏—Ö–∞—è –Ω–∞–¥–µ–∂–¥–∞",
        "meaning": "–ú–æ–∂–Ω–æ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –ø–æ–º–µ—á—Ç–∞—Ç—å –∏ –Ω–∞–º–µ—Ç–∏—Ç—å –¥–æ–±—Ä—ã–µ –ø–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ."
    },
    {
        "name": "–°–æ–ª–Ω—Ü–µ",
        "short": "—è—Å–Ω–æ—Å—Ç—å –∏ —Ä–∞–¥–æ—Å—Ç—å",
        "meaning": "–î–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ —Ä–∞–¥–æ—Å—Ç–∏, –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å –∏ –ø—Ä—è–º–æ–π, —á–µ—Å—Ç–Ω—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –≤–µ—â–∏."
    },
    {
        "name": "–ú–∏—Ä",
        "short": "–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ –≥–∞—Ä–º–æ–Ω–∏—è",
        "meaning": "–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –¥–æ–≤–µ—Å—Ç–∏ —á—Ç–æ-—Ç–æ –¥–æ –∫–æ–Ω—Ü–∞ –∏ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –æ–±–ª–µ–≥—á–µ–Ω–∏–µ."
    },
]


# ---------- –†–∞–±–æ—Ç–∞ —Å –æ–±—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (–≥–æ—Ä–æ—Å–∫–æ–ø—ã + —Ç–∞—Ä–æ) ----------

def load_astro_state() -> Dict[str, Any]:
    if not ASTRO_STATE_FILE.exists():
        return {}
    try:
        with ASTRO_STATE_FILE.open("r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return {}


def save_astro_state(state: Dict[str, Any]) -> None:
    ASTRO_STATE_FILE.parent.mkdir(parents=True, exist_ok=True)
    with ASTRO_STATE_FILE.open("w", encoding="utf-8") as f:
        json.dump(state, f, ensure_ascii=False, indent=2)


def get_season(now: datetime) -> str:
    month = now.month
    for name, months in SEASONS.items():
        if month in months:
            return name
    return "spring"


# ---------- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–∞ ----------

def build_horoscope_text(sign: str, now: datetime, history_texts: List[str]) -> str:
    today_str = now.strftime("%d.%m.%Y")
    weekday = now.strftime("%A")
    weekday_ru = {
        "Monday": "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
        "Tuesday": "–í—Ç–æ—Ä–Ω–∏–∫",
        "Wednesday": "–°—Ä–µ–¥–∞",
        "Thursday": "–ß–µ—Ç–≤–µ—Ä–≥",
        "Friday": "–ü—è—Ç–Ω–∏—Ü–∞",
        "Saturday": "–°—É–±–±–æ—Ç–∞",
        "Sunday": "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ",
    }.get(weekday, "–î–µ–Ω—å")

    season = get_season(now)
    season_phrase = random.choice(SEASON_PHRASES[season])
    day_type = random.choice(DAY_TYPES)

    love = random.choice(LOVE_PHRASES)
    work = random.choice(WORK_PHRASES)
    money = random.choice(MONEY_PHRASES)
    health = random.choice(HEALTH_PHRASES)
    advice = random.choice(ADVICE_PHRASES)

    number = random.choice(NUMBERS)
    color = random.choice(COLORS)

    text = (
        f"‚ú® {sign} ‚Äî –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
        f"üìÖ {weekday_ru}, {today_str}\n"
        f"üåÄ –¢–∏–ø –¥–Ω—è: {day_type}\n"
        f"üïä –°–µ–∑–æ–Ω–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π: {season_phrase}\n\n"
        f"üíñ –õ—é–±–æ–≤—å: {love}\n"
        f"üíº –†–∞–±–æ—Ç–∞: {work}\n"
        f"üí∞ –î–µ–Ω—å–≥–∏: {money}\n"
        f"üåø –ó–¥–æ—Ä–æ–≤—å–µ: {health}\n"
        f"üéØ –°–æ–≤–µ—Ç: {advice}\n"
        f"#Ô∏è‚É£ –ß–∏—Å–ª–æ –¥–Ω—è: {number}\n"
        f"üé® –¶–≤–µ—Ç –¥–Ω—è: {color}"
    )

    return text


def generate(sign: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –∑–Ω–∞–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:
    - –æ–¥–∏–Ω –æ–±—â–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ –∑–Ω–∞–∫
    - –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä –ø–æ —Ç–µ–∫—Å—Ç—É –Ω–∞ 14 –¥–Ω–µ–π
    """
    now = datetime.now(TZ)
    today_str = now.date().isoformat()

    state = load_astro_state()
    signs_state = state.setdefault("signs", {})
    sign_state = signs_state.setdefault(sign, {"history": []})

    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    today_entry = sign_state.get("today")
    if isinstance(today_entry, dict) and today_entry.get("date") == today_str:
        return today_entry.get("text", "")

    # –°–æ–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä–∞
    history: List[Dict[str, Any]] = sign_state.get("history", [])
    recent_texts = [h.get("text", "") for h in history[-14:]]

    # –ü—ã—Ç–∞–µ–º—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ –±—ã–ª–æ —Å—Ä–µ–¥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 14
    text = ""
    for _ in range(10):
        candidate = build_horoscope_text(sign, now, recent_texts)
        if candidate not in recent_texts:
            text = candidate
            break
    if not text:
        # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ 10 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ —Å–æ–≤–ø–∞–ª–æ ‚Äî –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
        text = build_horoscope_text(sign, now, recent_texts)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    new_entry = {"date": today_str, "text": text}
    sign_state["today"] = new_entry
    history.append(new_entry)
    # –ú–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, 60 –¥–Ω—è–º–∏
    if len(history) > 60:
        history = history[-60:]
    sign_state["history"] = history
    signs_state[sign] = sign_state
    state["signs"] = signs_state

    save_astro_state(state)
    return text


# ---------- –¢–∞—Ä–æ: 1 –∫–∞—Ä—Ç–∞ –≤ –¥–µ–Ω—å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ----------

def draw_tarot_for_user(user_id: int) -> Dict[str, Any]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    {
        "text": "...",
        "already_drawn": True/False
    }
    """
    now = datetime.now(TZ)
    today_str = now.date().isoformat()

    state = load_astro_state()
    tarot_state = state.setdefault("tarot", {})
    users_state = tarot_state.setdefault("users", {})

    key = str(user_id)
    user_entry = users_state.get(key)

    if isinstance(user_entry, dict) and user_entry.get("date") == today_str:
        card = user_entry.get("card", {})
        name = card.get("name", "–ö–∞—Ä—Ç–∞ –¥–Ω—è")
        short = card.get("short", "")
        meaning = card.get("meaning", "")
        text = (
            f"üîÆ –¢–∞—Ä–æ –¥–Ω—è: {name}\n"
            f"–ö–ª—é—á: {short}\n\n"
            f"{meaning}"
        )
        return {"text": text, "already_drawn": True}

    # –ò–Ω–∞—á–µ —Ç—è–Ω–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É
    card = random.choice(TAROT_CARDS)
    users_state[key] = {
        "date": today_str,
        "card": card,
    }
    tarot_state["users"] = users_state
    state["tarot"] = tarot_state
    save_astro_state(state)

    text = (
        f"üîÆ –¢–∞—Ä–æ –¥–Ω—è: {card['name']}\n"
        f"–ö–ª—é—á: {card['short']}\n\n"
        f"{card['meaning']}"
    )
    return {"text": text, "already_drawn": False}
