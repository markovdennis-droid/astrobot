import json
import random
from datetime import datetime, date
from pathlib import Path
from typing import Dict, Any, List

import pytz

BASE_DIR = Path(__file__).parent
ASTRO_STATE_FILE = BASE_DIR / "astro_state.json"

# –¢–∞–π–º–∑–æ–Ω–∞ (–ò—Å–ø–∞–Ω–∏—è)
TZ = pytz.timezone("Europe/Madrid")

ZODIAC_SIGNS = [
    "–û–≤–µ–Ω",
    "–¢–µ–ª–µ—Ü",
    "–ë–ª–∏–∑–Ω–µ—Ü—ã",
    "–†–∞–∫",
    "–õ–µ–≤",
    "–î–µ–≤–∞",
    "–í–µ—Å—ã",
    "–°–∫–æ—Ä–ø–∏–æ–Ω",
    "–°—Ç—Ä–µ–ª–µ—Ü",
    "–ö–æ–∑–µ—Ä–æ–≥",
    "–í–æ–¥–æ–ª–µ–π",
    "–†—ã–±—ã",
]

# ---------- –§—Ä–∞–∑—ã –¥–ª—è –≥–æ—Ä–æ—Å–∫–æ–ø–∞ ----------

SEASON_PHRASES: Dict[str, List[str]] = {
    "winter": [
        "–£—é—Ç–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–¥–≤–µ—Å—Ç–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –∏—Ç–æ–≥–∏.",
        "–•–æ—Ä–æ—à–µ–µ –≤—Ä–µ–º—è –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è –∏ —Å–æ–≥—Ä–µ—Ç—å—Å—è —á–µ–º-—Ç–æ –ø—Ä–∏—è—Ç–Ω—ã–º.",
        "–î–µ–Ω—å –±–æ–ª—å—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–ø–æ–∫–æ–π–Ω—ã—Ö –¥–µ–ª, —á–µ–º –¥–ª—è —Ä—ã–≤–∫–æ–≤.",
    ],
    "spring": [
        "–î–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º—è–≥–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –Ω–æ–≤—ã–µ –∏–¥–µ–∏.",
        "–ü–æ–¥—Ö–æ–¥–∏—Ç, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–µ–±–æ–ª—å—à–æ–µ, –Ω–æ —Å–≤–µ–∂–µ–µ.",
        "–í—Ä–µ–º—è —É–≤–∏–¥–µ—Ç—å, –≥–¥–µ –º–æ–∂–Ω–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–¥–≤–∏–Ω—É—Ç—å—Å—è —Å –º–µ—Å—Ç–∞.",
    ],
    "summer": [
        "–≠–Ω–µ—Ä–≥–∏—á–Ω—ã–π –¥–µ–Ω—å, –Ω–æ –ª—É—á—à–µ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ–±—è –¥–µ–ª–∞–º–∏.",
        "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ —Ä–∞–¥–æ—Å—Ç–∏ –∏ —Å–≤–µ—Ç–∞.",
        "–î–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∂–∏–≤–æ–µ –æ–±—â–µ–Ω–∏–µ –∏ –ø—Ä–æ—Å—Ç—ã–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è.",
    ],
    "autumn": [
        "–°–ø–æ–∫–æ–π–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –¥–µ–ª–∞—Ö –∏ –º—ã—Å–ª—è—Ö.",
        "–í—Ä–µ–º—è –º—è–≥–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏ —Ç–∏—Ö–æ–≥–æ —Ä–æ—Å—Ç–∞.",
        "–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –¥–æ–ø–∏—Å–∞—Ç—å, –¥–æ–¥–µ–ª–∞—Ç—å –∏ –Ω–µ–º–Ω–æ–≥–æ –≤—ã–¥–æ—Ö–Ω—É—Ç—å.",
    ],
}

DAY_TYPES: List[str] = [
    "–≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å",
    "–¥–µ–Ω—å –Ω–µ–±–æ–ª—å—à–∏—Ö, –Ω–æ –≤–∞–∂–Ω—ã—Ö —à–∞–≥–æ–≤",
    "—Å–ø–æ–∫–æ–π–Ω—ã–π –¥–µ–Ω—å —Å –º—è–≥–∫–∏–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏",
    "–¥–µ–Ω—å, –∫–æ–≥–¥–∞ –ª—É—á—à–µ –Ω–µ —Å–ø–µ—à–∏—Ç—å",
    "–¥–µ–Ω—å, –∫–æ–≥–¥–∞ –º–Ω–æ–≥–æ–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ—è",
]

LOVE_PHRASES: List[str] = [
    "–í –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –ø–æ–º–æ–∂–µ—Ç —Å–ø–æ–∫–æ–π–Ω—ã–π, —á–µ—Å—Ç–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä.",
    "–ü–æ–ª–µ–∑–Ω–æ —á—É—Ç—å –º—è–≥—á–µ –æ—Ç–Ω–µ—Å—Ç–∏—Å—å –∫ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞–º ‚Äî —Å–≤–æ–∏–º –∏ —á—É–∂–∏–º.",
    "–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø—Ä–æ—è–≤–∏—Ç—å –∑–∞–±–æ—Ç—É –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å.",
    "–ù–µ–±–æ–ª—å—à–æ–π –∑–Ω–∞–∫ –≤–Ω–∏–º–∞–Ω–∏—è —Å–¥–µ–ª–∞–µ—Ç —á—å–∏-—Ç–æ –≥–ª–∞–∑–∞ —Ç–µ–ø–ª–µ–µ.",
]

WORK_PHRASES: List[str] = [
    "–ù–∞ —Ä–∞–±–æ—Ç–µ –ª—É—á—à–µ –¥–≤–∏–≥–∞—Ç—å—Å—è —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, –±–µ–∑ —Ä—ã–≤–∫–æ–≤.",
    "–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ –æ–¥–Ω–æ–º –¥–µ–ª–µ ‚Äî —Ç–∞–∫ –±—ã—Å—Ç—Ä–µ–µ —É–≤–∏–¥–∏—à—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
    "–ü–æ–ª–µ–∑–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∏ –Ω–µ —Å—Ç–µ—Å–Ω—è—Ç—å—Å—è –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã.",
    "–°–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —É–ø–æ—Ä –Ω–∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—å, –∞ –Ω–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å.",
]

MONEY_PHRASES: List[str] = [
    "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ç—Ä–∞—Ç—ã.",
    "–ü–æ–¥–æ–π–¥—ë—Ç –¥–µ–Ω—å, —á—Ç–æ–±—ã —á—É—Ç—å —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏.",
    "–ü–æ–ª–µ–∑–Ω–æ –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ —Ä–∞—Å—Ö–æ–¥–∞—Ö –∏ –ø–ª–∞–Ω–∞—Ö –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü.",
    "–õ—É—á—à–µ –∏–∑–±–µ–≥–∞—Ç—å —Ä–µ–∑–∫–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –∞–≤–∞–Ω—Ç—é—Ä.",
]

HEALTH_PHRASES: List[str] = [
    "–ü–æ–ª–µ–∑–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É –¥–ª—è –¥—ã—Ö–∞–Ω–∏—è –∏ –ª—ë–≥–∫–æ–π —Ä–∞–∑–º–∏–Ω–∫–∏.",
    "–ü–æ–¥–æ–π–¥—ë—Ç –º—è–≥–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –ø—Ä–æ–≥—É–ª–∫–∞, —Ä–∞—Å—Ç—è–∂–∫–∞, —Å–ø–æ–∫–æ–π–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ.",
    "–°—Ç–æ–∏—Ç —á—É—Ç—å –±–µ—Ä–µ–∂–Ω–µ–µ –æ—Ç–Ω–µ—Å—Ç–∏—Å—å –∫ —Ä–µ–∂–∏–º—É —Å–Ω–∞ –∏ –æ—Ç–¥—ã—Ö–∞.",
    "–ù–µ–±–æ–ª—å—à–æ–π –ø–µ—Ä–µ—Ä—ã–≤ –æ—Ç –≥–∞–¥–∂–µ—Ç–æ–≤ –ø–æ–π–¥—ë—Ç –Ω–∞ –ø–æ–ª—å–∑—É –≥–æ–ª–æ–≤–µ –∏ –≥–ª–∞–∑–∞–º.",
]

ADVICE_PHRASES: List[str] = [
    "–°–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –Ω–µ–±–æ–ª—å—à–æ–π —à–∞–≥ –∫ —Ç–æ–º—É, —á—Ç–æ –¥–∞–≤–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—à—å.",
    "–ù–µ –ø—ã—Ç–∞–π—Å—è —É—Å–ø–µ—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É ‚Äî –≤—ã–±–µ—Ä–∏ –≥–ª–∞–≤–Ω–æ–µ.",
    "–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Ç—Ä–µ–≤–æ–∂–∏—Ç, –ª—É—á—à–µ —Å–ø–æ–∫–æ–π–Ω–æ –æ–±—Å—É–¥–∏—Ç—å, –∞ –Ω–µ –¥–µ—Ä–∂–∞—Ç—å –≤ —Å–µ–±–µ.",
    "–ù–∞–π–¥–∏ 10‚Äì15 –º–∏–Ω—É—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è ‚Äî –±–µ–∑ —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã.",
]

NUMBERS: List[int] = [1, 2, 3, 4, 5, 6, 7, 8, 9]
COLORS: List[str] = [
    "—è–Ω—Ç–∞—Ä–Ω—ã–π",
    "–∏–∑—É–º—Ä—É–¥–Ω—ã–π",
    "–Ω–µ–±–µ—Å–Ω–æ-–≥–æ–ª—É–±–æ–π",
    "—Ç–µ—Ä—Ä–∞–∫–æ—Ç–æ–≤—ã–π",
    "–æ–ª–∏–≤–∫–æ–≤—ã–π",
    "–ª–∞–≤–∞–Ω–¥–æ–≤—ã–π",
    "—Å–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π",
    "–∑–æ–ª–æ—Ç–∏—Å—Ç—ã–π",
]

# --- –¢–ê–†–û: —Ç–æ–ª—å–∫–æ —Å–≤–µ—Ç–ª—ã–µ –∫–∞—Ä—Ç—ã, 13 —à—Ç—É–∫ ---

TAROT_CARDS: List[Dict[str, str]] = [
    {
        "name": "–®—É—Ç",
        "short": "–Ω–æ–≤—ã–π —à–∞–≥",
        "meaning": "–ù–æ–≤—ã–π —à–∞–≥, –ª—ë–≥–∫–æ—Å—Ç—å, –∏–≥—Ä–∏–≤–æ—Å—Ç—å. –î–µ–Ω—å –¥–ª—è —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã—Ö, –Ω–æ –º—è–≥–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π.",
    },
    {
        "name": "–ú–∞–≥",
        "short": "—Ñ–æ–∫—É—Å –∏ –≤–æ–ª—è",
        "meaning": "–°–∏–ª–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏—è, –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ —Ñ–æ–∫—É—Å. –•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞—Ç—å —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ.",
    },
    {
        "name": "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –∂—Ä–∏—Ü–∞",
        "short": "–∏–Ω—Ç—É–∏—Ü–∏—è –∏ —Ç–∏—à–∏–Ω–∞",
        "meaning": "–ò–Ω—Ç—É–∏—Ü–∏—è, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≥–æ–ª–æ—Å, –º—É–¥—Ä–æ—Å—Ç—å. –•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –ø—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è –∫ —Å–µ–±–µ –∏ –Ω–µ —Å–ø–µ—à–∏—Ç—å.",
    },
    {
        "name": "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞",
        "short": "–∑–∞–±–æ—Ç–∞ –∏ —Ä–æ—Å—Ç",
        "meaning": "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –∑–∞–±–æ—Ç–∞ –∏ —Ä–æ—Å—Ç. –û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É—é—Ç–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±–ª–∏–∑–∫–∏—Ö.",
    },
    {
        "name": "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä",
        "short": "—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –æ–ø–æ—Ä–∞",
        "meaning": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞, –ø–æ—Ä—è–¥–æ–∫, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å. –°–¥–µ–ª–∞–π —à–∞–≥, –∫–æ—Ç–æ—Ä—ã–π —É–∫—Ä–µ–ø–ª—è–µ—Ç —Ç–µ–±—è –∏ —Ç–≤–æ–∏ –ø–ª–∞–Ω—ã.",
    },
    {
        "name": "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç",
        "short": "–æ–ø—ã—Ç –∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏",
        "meaning": "–û–ø–æ—Ä–∞ –Ω–∞ –∑–Ω–∞–Ω–∏—è, –æ–ø—ã—Ç –∏ —Å–æ–≤–µ—Ç. –î–µ–Ω—å, —á—Ç–æ–±—ã —É—á–∏—Ç—å—Å—è –∏–ª–∏ –¥–µ–ª–∏—Ç—å—Å—è —Ç–µ–º, —á—Ç–æ —Ç—ã –∑–Ω–∞–µ—à—å.",
    },
    {
        "name": "–í–ª—é–±–ª—ë–Ω–Ω—ã–µ",
        "short": "–≤—ã–±–æ—Ä —Å–µ—Ä–¥—Ü–µ–º",
        "meaning": "–í—ã–±–æ—Ä —Å–µ—Ä–¥—Ü–µ–º, –≥–∞—Ä–º–æ–Ω–∏—è –∏ —Å–≤—è–∑—å. –•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç —É–¥–µ–ª–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º –∏ –≤–∞–∂–Ω—ã–º —Ä–µ—à–µ–Ω–∏—è–º.",
    },
    {
        "name": "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞",
        "short": "–¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥",
        "meaning": "–î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥, –ø–æ–±–µ–¥–∞, –∫–æ–Ω—Ç—Ä–æ–ª—å. –í—Ä–µ–º—è –≤–∑—è—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é –≤ —Å–≤–æ–∏ —Ä—É–∫–∏ –∏ —Å–¥–µ–ª–∞—Ç—å —à–∞–≥ –∫ —Ü–µ–ª–∏.",
    },
    {
        "name": "–°–∏–ª–∞",
        "short": "–º—è–≥–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å",
        "meaning": "–ú—è–≥–∫–∞—è —Å–∏–ª–∞, —Ç–µ—Ä–ø–µ–Ω–∏–µ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å. –°–ø–æ–∫–æ–π–Ω–∞—è –æ–ø–æ—Ä–∞ –≤–∞–∂–Ω–µ–µ, —á–µ–º –¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ–±—è –∏ –¥—Ä—É–≥–∏—Ö.",
    },
    {
        "name": "–ó–≤–µ–∑–¥–∞",
        "short": "—Ç–∏—Ö–∞—è –Ω–∞–¥–µ–∂–¥–∞",
        "meaning": "–ù–∞–¥–µ–∂–¥–∞, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, —Å–≤–µ—Ç. –ú–æ–∂–Ω–æ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –ø–æ–º–µ—á—Ç–∞—Ç—å –∏ –Ω–∞–º–µ—Ç–∏—Ç—å –¥–æ–±—Ä—ã–µ –ø–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ.",
    },
    {
        "name": "–°–æ–ª–Ω—Ü–µ",
        "short": "—è—Å–Ω–æ—Å—Ç—å –∏ —Ä–∞–¥–æ—Å—Ç—å",
        "meaning": "–£—Å–ø–µ—Ö, —è—Å–Ω–æ—Å—Ç—å, —ç–Ω–µ—Ä–≥–∏—è. –î–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ —Ä–∞–¥–æ—Å—Ç–∏ –∏ —á–µ—Å—Ç–Ω—ã–π, –æ—Ç–∫—Ä—ã—Ç—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –∂–∏–∑–Ω—å.",
    },
    {
        "name": "–ú–∏—Ä",
        "short": "–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ –≥–∞—Ä–º–æ–Ω–∏—è",
        "meaning": "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ü–∏–∫–ª–∞, –≥–∞—Ä–º–æ–Ω–∏—è –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å. –•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç —á—Ç–æ-—Ç–æ –∑–∞–∫–æ–Ω—á–∏—Ç—å –∏ –≤—ã–¥–æ—Ö–Ω—É—Ç—å.",
    },
    {
        "name": "–û—Ç—à–µ–ª—å–Ω–∏–∫",
        "short": "–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—É—Ç—å",
        "meaning": "–ú—É–¥—Ä–æ—Å—Ç—å, —É–µ–¥–∏–Ω–µ–Ω–∏–µ, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—É—Ç—å. –ü–æ–ª–µ–∑–Ω–æ –ø–æ–±—ã—Ç—å –Ω–∞–µ–¥–∏–Ω–µ —Å —Å–æ–±–æ–π –∏ —Å–ø–æ–∫–æ–π–Ω–æ –≤—Å—ë –æ–±–¥—É–º–∞—Ç—å.",
    },
]

# ---------- –†–∞–±–æ—Ç–∞ —Å –æ–±—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (–≥–æ—Ä–æ—Å–∫–æ–ø—ã + —Ç–∞—Ä–æ) ----------


def load_astro_state() -> Dict[str, Any]:
    if not ASTRO_STATE_FILE.exists():
        return {}
    try:
        with ASTRO_STATE_FILE.open("r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return {}


def save_astro_state(state: Dict[str, Any]) -> None:
    ASTRO_STATE_FILE.parent.mkdir(parents=True, exist_ok=True)
    with ASTRO_STATE_FILE.open("w", encoding="utf-8") as f:
        json.dump(state, f, ensure_ascii=False, indent=2)


def get_season(now: datetime) -> str:
    month = now.month
    if month in (12, 1, 2):
        return "winter"
    elif month in (3, 4, 5):
        return "spring"
    elif month in (6, 7, 8):
        return "summer"
    else:
        return "autumn"


def build_horoscope_text(sign: str, now: datetime, recent_texts: List[str]) -> str:
    today_str = now.strftime("%d.%m.%Y")
    weekday = now.strftime("%A")

    weekday_ru = {
        "Monday": "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
        "Tuesday": "–í—Ç–æ—Ä–Ω–∏–∫",
        "Wednesday": "–°—Ä–µ–¥–∞",
        "Thursday": "–ß–µ—Ç–≤–µ—Ä–≥",
        "Friday": "–ü—è—Ç–Ω–∏—Ü–∞",
        "Saturday": "–°—É–±–±–æ—Ç–∞",
        "Sunday": "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ",
    }.get(weekday, "–î–µ–Ω—å")

    season = get_season(now)
    season_phrase = random.choice(SEASON_PHRASES[season])
    day_type = random.choice(DAY_TYPES)

    love = random.choice(LOVE_PHRASES)
    work = random.choice(WORK_PHRASES)
    money = random.choice(MONEY_PHRASES)
    health = random.choice(HEALTH_PHRASES)
    advice = random.choice(ADVICE_PHRASES)
    number = random.choice(NUMBERS)
    color = random.choice(COLORS)

    text = (
        f"‚ú® {sign} ‚Äî –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
        f"üìÖ {weekday_ru}, {today_str}\n"
        f"üåÄ –¢–∏–ø –¥–Ω—è: {day_type}\n"
        f"üïä –°–µ–∑–æ–Ω–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π: {season_phrase}\n\n"
        f"üíñ –õ—é–±–æ–≤—å: {love}\n"
        f"üíº –†–∞–±–æ—Ç–∞: {work}\n"
        f"üí∞ –î–µ–Ω—å–≥–∏: {money}\n"
        f"üåø –ó–¥–æ—Ä–æ–≤—å–µ: {health}\n"
        f"üéØ –°–æ–≤–µ—Ç: {advice}\n"
        f"#Ô∏è‚É£ –ß–∏—Å–ª–æ –¥–Ω—è: {number}\n"
        f"üé® –¶–≤–µ—Ç –¥–Ω—è: {color}"
    )

    return text


def generate(sign: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –∑–Ω–∞–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:
    - –æ–¥–∏–Ω –æ–±—â–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ –∑–Ω–∞–∫
    - –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä –ø–æ —Ç–µ–∫—Å—Ç—É –Ω–∞ 14 –¥–Ω–µ–π
    """
    now = datetime.now(TZ)
    today_str = now.date().isoformat()

    state = load_astro_state()
    signs_state = state.setdefault("signs", {})
    sign_state = signs_state.setdefault(sign, {})

    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    today_entry = sign_state.get("today")
    if isinstance(today_entry, dict) and today_entry.get("date") == today_str:
        return today_entry.get("text", "")

    # –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä–∞
    history: List[Dict[str, Any]] = sign_state.get("history", [])
    recent_texts = [h.get("text", "") for h in history[-14:]]

    text = ""
    for _ in range(10):
        candidate = build_horoscope_text(sign, now, recent_texts)
        if candidate not in recent_texts:
            text = candidate
            break
    if not text:
        text = build_horoscope_text(sign, now, recent_texts)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    sign_state["today"] = {
        "date": today_str,
        "text": text,
    }
    history.append(
        {
            "date": today_str,
            "text": text,
        }
    )
    # –æ–≥—Ä–∞–Ω–∏—á–∏–º –∏—Å—Ç–æ—Ä–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä 60 –∑–∞–ø–∏—Å—è–º–∏
    sign_state["history"] = history[-60:]
    signs_state[sign] = sign_state
    state["signs"] = signs_state
    save_astro_state(state)

    return text


def draw_tarot_for_user(user_id: int) -> Dict[str, Any]:
    """
    –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–ê–Ø –∫–∞—Ä—Ç–∞ –¢–∞—Ä–æ.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    {
        "text": "...",
        "already_drawn": True/False,
        "card_name": "–ò–º—è –∫–∞—Ä—Ç—ã"
    }
    –ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ä–∞–∑ –≤ 7 –¥–Ω–µ–π.
    """
    now = datetime.now(TZ)
    today = now.date()

    state = load_astro_state()
    tarot_state = state.setdefault("tarot", {})
    users_state = tarot_state.setdefault("users", {})

    key = str(user_id)
    user_entry = users_state.get(key)

    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–∞ ‚Äì –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –¥–Ω—è—Ö
    if isinstance(user_entry, dict) and "date" in user_entry:
        last_date = date.fromisoformat(user_entry["date"])
        delta_days = (today - last_date).days

        if delta_days < 7:
            # –ï—â—ë –Ω–µ –ø—Ä–æ—à–ª–æ 7 –¥–Ω–µ–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç—É –∂–µ –∫–∞—Ä—Ç—É
            card = user_entry.get("card", {})
            name = card.get("name", "–ö–∞—Ä—Ç–∞")
            short = card.get("short", "")
            meaning = card.get("meaning", "")
            text = (
                f"üîÆ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –¢–∞—Ä–æ: {name}\n"
                f"–ö–ª—é—á: {short}\n\n"
                f"{meaning}"
            )
            return {"text": text, "already_drawn": True, "card_name": name}

    # –ò–Ω–∞—á–µ —Ç—è–Ω–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É
    card = random.choice(TAROT_CARDS)
    users_state[key] = {
        "date": today.isoformat(),
        "card": card,
    }
    tarot_state["users"] = users_state
    state["tarot"] = tarot_state
    save_astro_state(state)

    text = (
        f"üîÆ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –¢–∞—Ä–æ: {card['name']}\n"
        f"–ö–ª—é—á: {card['short']}\n\n"
        f"{card['meaning']}"
    )
    return {
        "text": text,
        "already_drawn": False,
        "card_name": card["name"],
    }
