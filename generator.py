#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import random
import datetime
import json
import os
from typing import Optional

# ---------------------------------------------
# –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
# ---------------------------------------------

SIGNS = [
    "aries", "taurus", "gemini", "cancer", "leo", "virgo",
    "libra", "scorpio", "sagittarius", "capricorn", "aquarius", "pisces",
]

RU_SIGNS = {
    "aries":       "‚ôà –û–≤–µ–Ω",
    "taurus":      "‚ôâ –¢–µ–ª–µ—Ü",
    "gemini":      "‚ôä –ë–ª–∏–∑–Ω–µ—Ü—ã",
    "cancer":      "‚ôã –†–∞–∫",
    "leo":         "‚ôå –õ–µ–≤",
    "virgo":       "‚ôç –î–µ–≤–∞",
    "libra":       "‚ôé –í–µ—Å—ã",
    "scorpio":     "‚ôè –°–∫–æ—Ä–ø–∏–æ–Ω",
    "sagittarius": "‚ôê –°—Ç—Ä–µ–ª–µ—Ü",
    "capricorn":   "‚ôë –ö–æ–∑–µ—Ä–æ–≥",
    "aquarius":    "‚ôí –í–æ–¥–æ–ª–µ–π",
    "pisces":      "‚ôì –†—ã–±—ã",
}

STYLES = {
    "classic": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø",
    "humor": "–Æ–º–æ—Ä–Ω–æ–π –≥–æ—Ä–æ—Å–∫–æ–ø",
    "mystic": "–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø",
    "motivation": "–ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø",
}

CACHE_FILE = "daily_horoscopes.json"   # —Ç—É—Ç —Ö—Ä–∞–Ω–∏–º —Ç–µ–∫—Å—Ç—ã –ø–æ –¥–∞—Ç–∞–º/–∑–Ω–∞–∫–∞–º
ANTIREPEAT_DAYS = 14                   # –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π
MAX_GENERATION_TRIES = 20              # —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç


# ---------------------------------------------
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–≠–®–ê
# ---------------------------------------------

def _load_cache() -> dict:
    if not os.path.exists(CACHE_FILE):
        return {}
    try:
        with open(CACHE_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
        if isinstance(data, dict):
            return data
    except Exception:
        return {}
    return {}


def _save_cache(data: dict) -> None:
    try:
        with open(CACHE_FILE, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception:
        # –µ—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Äî –Ω–µ –ª–æ–º–∞–µ–º –±–æ—Ç–∞
        pass


# ---------------------------------------------
# –°–ï–ó–û–ù–´ / –¢–û–ù –î–ù–Ø / –°–õ–û–í–ê–†–ò –¢–ï–ö–°–¢–û–í
# ---------------------------------------------

def _get_season(date_obj: datetime.date) -> str:
    m = date_obj.month
    if m in (12, 1, 2):
        return "winter"
    if m in (3, 4, 5):
        return "spring"
    if m in (6, 7, 8):
        return "summer"
    return "autumn"


SEASON_TEXT = {
    "winter": "–ó–∏–º–∞ –¥–∞—ë—Ç —à–∞–Ω—Å –ø—Ä–∏—Ç–æ—Ä–º–æ–∑–∏—Ç—å –∏ —É—Å–ª—ã—à–∞—Ç—å —Å–µ–±—è.",
    "spring": "–í–µ—Å–Ω–∞ –∑–∞—Ä—è–∂–∞–µ—Ç —Ä–æ—Å—Ç–æ–º, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏ –Ω–æ–≤—ã–º–∏ –∏–¥–µ—è–º–∏.",
    "summer": "–õ–µ—Ç–æ —É—Å–∏–ª–∏–≤–∞–µ—Ç —ç–º–æ—Ü–∏–∏ –∏ –∑–æ–≤—ë—Ç –∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
    "autumn": "–û—Å–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ –æ—Ç–ø—É—Å—Ç–∏—Ç—å –ª–∏—à–Ω–µ–µ.",
}

DAY_TONES = {
    "light": {
        "name": "–õ—ë–≥–∫–∏–π –¥–µ–Ω—å",
        "description": [
            "–≠–Ω–µ—Ä–≥–∏—è –º—è–≥–∫–∞—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è, –º–Ω–æ–≥–æ–µ –¥–∞—ë—Ç—Å—è –ø—Ä–æ—â–µ –æ–±—ã—á–Ω–æ–≥–æ.",
            "–ú–æ–∂–Ω–æ –Ω–µ —Å–ø–µ—à–∏—Ç—å ‚Äî –≤–∞–∂–Ω–æ –Ω–∞—Å–ª–∞–∂–¥–∞—Ç—å—Å—è –ø—Ä–æ—Ü–µ—Å—Å–æ–º –∏ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ —Ä–∞–¥–æ—Å—Ç—è–º–∏.",
            "–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏ –Ω–µ –≤–∑–≤–∞–ª–∏–≤–∞—Ç—å –Ω–∞ —Å–µ–±—è –ª–∏—à–Ω–µ–≥–æ.",
        ],
    },
    "balanced": {
        "name": "–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å",
        "description": [
            "–°–∏–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã –∏ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å, –∏ —É–¥–µ–ª–∏—Ç—å –≤—Ä–µ–º—è –ª–∏—á–Ω–æ–º—É.",
            "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É –¥–µ–ª–∞–º–∏ –∏ –æ—Ç–¥—ã—Ö–æ–º.",
            "–ú–∏—Ä –≤–æ–∫—Ä—É–≥ –æ—Ç–≤–µ—á–∞–µ—Ç –≤–∑–∞–∏–º–Ω–æ—Å—Ç—å—é, –µ—Å–ª–∏ –≤—ã –¥–µ–π—Å—Ç–≤—É–µ—Ç–µ –º—è–≥–∫–æ –∏ —á–µ—Å—Ç–Ω–æ.",
        ],
    },
    "strong": {
        "name": "–°–∏–ª—å–Ω—ã–π –¥–µ–Ω—å",
        "description": [
            "–í–Ω—É—Ç—Ä–∏ –º–Ω–æ–≥–æ —Ä–µ—à–∏–º–æ—Å—Ç–∏ ‚Äî –≥–ª–∞–≤–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –µ—ë –≤ –Ω—É–∂–Ω–æ–µ —Ä—É—Å–ª–æ.",
            "–≠—Ç–æ –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ —Å–¥–≤–∏–Ω—É—Ç—å —Å –º–µ—Å—Ç–∞ —Ç–æ, —á—Ç–æ –¥–∞–≤–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–ª–æ—Å—å.",
            "–î–µ–Ω—å —Ç—Ä–µ–±—É–µ—Ç —è—Å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ —Å–º–µ–ª—ã—Ö —à–∞–≥–æ–≤.",
        ],
    },
}

LOVE_TEXTS = [
    "–ì–æ–≤–æ—Ä–∏—Ç–µ –ø—Ä—è–º–æ –∏ –±–µ—Ä–µ–∂–Ω–æ ‚Äî –º–µ–Ω—å—à–µ –¥–æ–≥–∞–¥–æ–∫, –±–æ–ª—å—à–µ —á–µ—Å—Ç–Ω–æ—Å—Ç–∏.",
    "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –Ω–∞–ø–æ–º–Ω–∏—Ç—å –±–ª–∏–∑–∫–∏–º, —á—Ç–æ –æ–Ω–∏ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω—ã.",
    "–ü—Ä–æ—è–≤–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ: –Ω–µ–±–æ–ª—å—à–æ–π –∑–Ω–∞–∫ –≤–Ω–∏–º–∞–Ω–∏—è —Å–µ–π—á–∞—Å –æ–∑–Ω–∞—á–∞–µ—Ç –æ—á–µ–Ω—å –º–Ω–æ–≥–æ.",
    "–ù–µ –¥–µ—Ä–∂–∏—Ç–µ —ç–º–æ—Ü–∏–∏ –≤ —Å–µ–±–µ, –Ω–æ –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å–ø–æ–∫–æ–π–Ω—ã–π —Ç–æ–Ω.",
]

WORK_TEXTS = [
    "–°–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –æ–¥–Ω–æ–º –¥–µ–ª–µ, –Ω–µ —Ä–∞–∑–±—Ä–∞—Å—ã–≤–∞–π—Ç–µ—Å—å.",
    "–ú–æ–∂–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –≤–∏—Å—è—â–∏–µ –∑–∞–¥–∞—á–∏ –∏ –Ω–∞–≤–æ–¥–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫.",
    "–ù–µ –±–æ–π—Ç–µ—Å—å —É—Ç–æ—á–Ω—è—Ç—å –¥–µ—Ç–∞–ª–∏ ‚Äî —ç—Ç–æ –∏–∑–±–∞–≤–∏—Ç –æ—Ç –æ—à–∏–±–æ–∫.",
    "–õ—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, —á–µ–º —Ö–≤–∞—Ç–∞—Ç—å—Å—è –∑–∞ –≤—Å—ë —Å—Ä–∞–∑—É.",
]

MONEY_TEXTS = [
    "–ë—É–¥—å—Ç–µ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã –∏ –∏–∑–±–µ–≥–∞–π—Ç–µ –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫.",
    "–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –±—é–¥–∂–µ—Ç –∏ —É–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ —Ç—Ä–∞—Ç—ã.",
    "–ú–∞–ª–µ–Ω—å–∫–∞—è —ç–∫–æ–Ω–æ–º–∏—è —Å–µ–≥–æ–¥–Ω—è –¥–∞—Å—Ç —Å–≤–æ–±–æ–¥—É –∑–∞–≤—Ç—Ä–∞.",
    "–ò–∑—É—á–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å —á—Ç–æ-—Ç–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ.",
]

HEALTH_TEXTS = [
    "–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–æ –ø—Ä–æ—Å—Ç—ã–º–∏ –≤–µ—â–∞–º–∏: —Å–æ–Ω, –≤–æ–¥–∞, –Ω–µ–º–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è.",
    "–°–æ–∫—Ä–∞—Ç–∏—Ç–µ —ç–∫—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é –ø—Ä–æ–≥—É–ª–∫—É.",
    "–û—Ä–≥–∞–Ω–∏–∑—É–π—Ç–µ –º—è–≥–∫–∏–π —Ä–µ–∂–∏–º: –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–æ–∫ –∏ —Ä–µ–∑–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.",
    "–ü–æ–ª–µ–∑–Ω–æ —Ä–∞–∑–≥—Ä—É–∑–∏—Ç—å –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É ‚Äî –º–µ–Ω—å—à–µ –Ω–æ–≤–æ—Å—Ç–Ω–æ–≥–æ —à—É–º–∞.",
]

GENERAL_TIPS = [
    "–°–¥–µ–ª–∞–π—Ç–µ –æ–¥–Ω–æ –º–∞–ª–µ–Ω—å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏–±–ª–∏–∑–∏—Ç –≤–∞—Å –∫ –≤–∞—à–µ–π —Ü–µ–ª–∏.",
    "–í—ã–¥–µ–ª–∏—Ç–µ —Ö–æ—Ç—è –±—ã 10 –º–∏–Ω—É—Ç —Ç–∏—à–∏–Ω—ã –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.",
    "–ó–∞–ø–∏—à–∏—Ç–µ —Ç—Ä–∏ –≤–µ—â–∏, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã —Å–µ–≥–æ–¥–Ω—è.",
    "–ù–µ —Å–ø–æ—Ä—å—Ç–µ –∏–∑ –ø—Ä–∏–Ω—Ü–∏–ø–∞ ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ —Ç–æ, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è.",
]

LUCKY_COLORS = [
    "—è–Ω—Ç–∞—Ä–Ω—ã–π", "–∏–∑—É–º—Ä—É–¥–Ω—ã–π", "–ª–∞–∑—É—Ä–Ω—ã–π", "—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π",
    "—Ç–µ—Ä—Ä–∞–∫–æ—Ç–æ–≤—ã–π", "–∑–æ–ª–æ—Ç–∏—Å—Ç—ã–π", "–æ–ª–∏–≤–∫–æ–≤—ã–π", "–≥—Ä–∞—Ñ–∏—Ç–æ–≤—ã–π",
]


# ---------------------------------------------
# –í–ù–£–¢–†–ï–ù–ù–ò–ô –ì–ï–ù–ï–†–ê–¢–û–† –û–î–ù–û–ì–û –¢–ï–ö–°–¢–ê
# (–±–µ–∑ –∫—ç—à–∞ –∏ –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä–∞)
# ---------------------------------------------

def _format_date_for_header(dt: Optional[str]) -> tuple[datetime.date, str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (date_obj, —Ç–µ–∫—Å—Ç –¥–ª—è —à–∞–ø–∫–∏).
    –ï—Å–ª–∏ dt=None -> —Å–µ–≥–æ–¥–Ω—è, —Ç–µ–∫—Å—Ç '—Å–µ–≥–æ–¥–Ω—è'.
    –ï—Å–ª–∏ dt='YYYY-MM-DD' -> —ç—Ç–∞ –¥–∞—Ç–∞, —Ç–µ–∫—Å—Ç '–Ω–∞ –¥–∞—Ç—É ...'
    """
    if dt:
        try:
            date_obj = datetime.date.fromisoformat(dt)
            when_text = f"–Ω–∞ –¥–∞—Ç—É {date_obj.strftime('%d.%m.%Y')}"
            return date_obj, when_text
        except Exception:
            pass
    date_obj = datetime.date.today()
    return date_obj, "—Å–µ–≥–æ–¥–Ω—è"


def _generate_one(sign: str, style: str, lang: str, dt: Optional[str]) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –û–î–ò–ù –≤–∞—Ä–∏–∞–Ω—Ç —Ç–µ–∫—Å—Ç–∞ (–º–æ–∂–µ—Ç —Å–æ–≤–ø–∞—Å—Ç—å —Å –ø—Ä–æ—à–ª—ã–º).
    –í—Å—è –ª–æ–≥–∏–∫–∞ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è ‚Äî –∑–¥–µ—Å—å.
    """
    date_obj, when_text = _format_date_for_header(dt)
    season = _get_season(date_obj)
    season_line = SEASON_TEXT[season]

    tone_key = random.choice(list(DAY_TONES.keys()))
    tone = DAY_TONES[tone_key]["name"]
    tone_desc = random.choice(DAY_TONES[tone_key]["description"])

    sign_ru = RU_SIGNS.get(sign, sign.upper())
    style_ru = STYLES.get(style, "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø")

    header = f"{sign_ru} ‚Äî {style_ru} | {when_text}"

    # –ë–ª–æ–∫–∏
    love = random.choice(LOVE_TEXTS)
    work = random.choice(WORK_TEXTS)
    money = random.choice(MONEY_TEXTS)
    health = random.choice(HEALTH_TEXTS)
    general_tip = random.choice(GENERAL_TIPS)

    lucky_number = random.randint(1, 99)
    lucky_color = random.choice(LUCKY_COLORS)

    # –ü–∞—Ä–∞ —Ä–∞–∑–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–µ–∫—Å—Ç–∞,
    # —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç—ã –æ—Ç–ª–∏—á–∞–ª–∏—Å—å –Ω–µ —Ç–æ–ª—å–∫–æ —Ñ—Ä–∞–∑–∞–º–∏, –Ω–æ –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ–º.
    structure_type = random.choice([1, 2, 3])

    if structure_type == 1:
        body = (
            f"üéØ –û–±—â–∏–π —Ñ–æ–Ω: {tone}. {tone_desc}\n"
            f"üåÄ –°–µ–∑–æ–Ω: {season_line}\n\n"
            f"üíñ –õ—é–±–æ–≤—å: {love}\n"
            f"üíº –†–∞–±–æ—Ç–∞: {work}\n"
            f"üí∞ –î–µ–Ω—å–≥–∏: {money}\n"
            f"üåø –ó–¥–æ—Ä–æ–≤—å–µ: {health}\n\n"
            f"‚ú® –°–æ–≤–µ—Ç –¥–Ω—è: {general_tip}\n"
            f"#Ô∏è‚É£ –ß–∏—Å–ª–æ –¥–Ω—è: {lucky_number}\n"
            f"üé® –¶–≤–µ—Ç –¥–Ω—è: {lucky_color}"
        )
    elif structure_type == 2:
        body = (
            f"üéØ –î–µ–Ω—å: {tone}. {tone_desc}\n\n"
            f"üíº –î–µ–ªa –∏ —Ü–µ–ª–∏: {work}\n"
            f"üíñ –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –±–ª–∏–∑–∫–∏–µ: {love}\n"
            f"üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ñ–æ–Ω: {money}\n"
            f"üåø –≠–Ω–µ—Ä–≥–∏—è –∏ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ: {health}\n\n"
            f"üåÄ –°–µ–∑–æ–Ω–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç: {season_line}\n"
            f"‚ú® –ù–µ–±–æ–ª—å—à–æ–π —à–∞–≥ —Å–µ–≥–æ–¥–Ω—è: {general_tip}\n"
            f"#Ô∏è‚É£ –°—á–∞—Å—Ç–ª–∏–≤–æ–µ —á–∏—Å–ª–æ: {lucky_number}\n"
            f"üé® –¶–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏—Ç: {lucky_color}"
        )
    else:
        body = (
            f"üéØ –í–µ–∫—Ç–æ—Ä –¥–Ω—è: {tone}. {tone_desc}\n"
            f"üåÄ –°–µ–∑–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: {season_line}\n\n"
            f"üíñ –°–µ—Ä–¥–µ—á–Ω–∞—è —Å—Ñ–µ—Ä–∞: {love}\n"
            f"üíº –†–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã: {work}\n"
            f"üí∞ –î–µ–Ω—å–≥–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã: {money}\n"
            f"üåø –¢–µ–ª–æ –∏ –Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: {health}\n\n"
            f"‚ú® –ì–ª–∞–≤–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {general_tip}\n"
            f"#Ô∏è‚É£ –ß–∏—Å–ª–æ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ: {lucky_number}\n"
            f"üé® –¶–≤–µ—Ç –¥–Ω—è: {lucky_color}"
        )

    return f"{header}\n\n{body}"


# ---------------------------------------------
# –ü–£–ë–õ–ò–ß–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø generate
# (–∫—ç—à, –æ–±—â–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ –¥–µ–Ω—å –¥–ª—è –∑–Ω–∞–∫–∞, –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä)
# ---------------------------------------------

def generate(sign: str, style: str = "classic", lang: str = "ru", dt: Optional[str] = None) -> str:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –≤—ã–∑—ã–≤–∞–µ—Ç –±–æ—Ç.

    –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:
    - –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      –æ–¥–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ / —Å—Ç–∏–ª—è / —è–∑—ã–∫–∞;
    - –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –û–î–ò–ù –ò –¢–û–¢ –ñ–ï —Ç–µ–∫—Å—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö ANTIREPEAT_DAYS
      –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–Ω–∞–∫–∞.
    """
    # –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Ö–æ–¥
    sign_key = (sign or "").lower()
    if sign_key not in SIGNS:
        sign_key = "aries"

    style_key = style or "classic"
    lang_key = lang or "ru"

    date_obj, _ = _format_date_for_header(dt)
    date_key = date_obj.isoformat()
    cache_key = f"{sign_key}:{style_key}:{lang_key}"

    cache = _load_cache()
    day_cache = cache.setdefault(date_key, {})

    # 1. –ï—Å–ª–∏ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –¥–ª—è –∑–Ω–∞–∫–∞ —É–∂–µ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º.
    if cache_key in day_cache:
        return day_cache[cache_key]

    # 2. –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ANTIREPEAT_DAYS –¥–ª—è —ç—Ç–æ–≥–æ –∑–Ω–∞–∫–∞,
    #    —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å —Å–ª–æ–≤–æ-–≤-—Å–ª–æ–≤–æ.
    cutoff_date = date_obj - datetime.timedelta(days=ANTIREPEAT_DAYS)
    recent_texts = set()

    for d_str, data in cache.items():
        try:
            d_obj = datetime.date.fromisoformat(d_str)
        except Exception:
            continue
        if d_obj < cutoff_date or d_obj >= date_obj:
            continue
        if not isinstance(data, dict):
            continue
        t = data.get(cache_key)
        if isinstance(t, str):
            recent_texts.add(t)

    # 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥—ë–º –Ω–æ–≤—ã–π, –æ—Ç–ª–∏—á–Ω—ã–π –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö
    text = ""
    for _ in range(MAX_GENERATION_TRIES):
        candidate = _generate_one(sign_key, style_key, lang_key, dt)
        if candidate not in recent_texts:
            text = candidate
            break
        text = candidate  # –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ–≤–ø–∞–ª–∏

    # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
    day_cache[cache_key] = text
    cache[date_key] = day_cache
    _save_cache(cache)

    return text
