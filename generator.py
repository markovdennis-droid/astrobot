import random
from datetime import date

# --- Список карт Таро (твоя кастомная колода 13 карт) ---

CARDS = [
    {
        "name": "Шут",
        "text": "Новый шаг, лёгкость, игривость. День для спонтанных решений."
    },
    {
        "name": "Маг",
        "text": "Сила намерения, контроль и фокус. Хороший момент начать что-то важное."
    },
    {
        "name": "Верховная жрица",
        "text": "Интуиция, внутренний голос, мудрость. Прислушайся к себе."
    },
    {
        "name": "Императрица",
        "text": "Творчество, забота и рост. Отличный день для создания и проявления."
    },
    {
        "name": "Император",
        "text": "Структура, порядок, уверенность. Сделай шаг, который укрепляет тебя."
    },
    {
        "name": "Иерофант",
        "text": "Опора на традиции, знания и опыт. День, чтобы учиться или учить."
    },
    {
        "name": "Влюблённые",
        "text": "Выбор сердцем, гармония и связь. Хороший день для отношений."
    },
    {
        "name": "Колесница",
        "text": "Движение вперёд, победа, контроль. Время взять ситуацию в свои руки."
    },
    {
        "name": "Сила",
        "text": "Мягкая сила, терпение и уверенность. Спокойно, но уверенно к цели."
    },
    {
        "name": "Звезда",
        "text": "Надежда, вдохновение, свет. Доверяй процессу — всё складывается."
    },
    {
        "name": "Солнце",
        "text": "Успех, ясность, энергия. Радость дня и чистые намерения."
    },
    {
        "name": "Мир",
        "text": "Завершение цикла, гармония и внутренняя целостность."
    },
    {
        "name": "Отшельник",
        "text": "Мудрость, уединение, внутренний путь. День, чтобы услышать себя."
    },
]


# --- Хранилище для контроля "1 карта в день" ---
user_tarot_history = {}  # user_id: {"date": date, "card": {...}}


# --- Основная функция вытягивания карты ---
def draw_tarot_for_user(user_id):
    today = date.today()

    # Если пользователь уже вытягивал карту сегодня — возвращаем ту же
    if user_id in user_tarot_history:
        stored = user_tarot_history[user_id]
        if stored["date"] == today:
            return {
                "text": stored["card"]["text"],
                "already_drawn": True,
                "card_name": stored["card"]["name"],
            }

    # Если сегодня ещё не вытягивал
    card = random.choice(CARDS)

    # Сохраняем карту пользователю
    user_tarot_history[user_id] = {
        "date": today,
        "card": card,
    }

    return {
        "text": card["text"],
        "already_drawn": False,
        "card_name": card["name"],
    }
