from __future__ import annotations

import json
import random
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Any
from zoneinfo import ZoneInfo

BASE_DIR = Path(__file__).parent
STATE_FILE = BASE_DIR / "astro_state.json"
TZ = ZoneInfo("Europe/Madrid")

ZODIAC_SIGNS = [
    "–û–≤–µ–Ω",
    "–¢–µ–ª–µ—Ü",
    "–ë–ª–∏–∑–Ω–µ—Ü—ã",
    "–†–∞–∫",
    "–õ–µ–≤",
    "–î–µ–≤–∞",
    "–í–µ—Å—ã",
    "–°–∫–æ—Ä–ø–∏–æ–Ω",
    "–°—Ç—Ä–µ–ª–µ—Ü",
    "–ö–æ–∑–µ—Ä–æ–≥",
    "–í–æ–¥–æ–ª–µ–π",
    "–†—ã–±—ã",
]


def _load_state() -> Dict[str, Any]:
    if not STATE_FILE.exists():
        return {}
    try:
        with STATE_FILE.open("r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        # –µ—Å–ª–∏ —Ñ–∞–π–ª –±–∏—Ç—ã–π ‚Äì –Ω–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
        return {}


def _save_state(state: Dict[str, Any]) -> None:
    STATE_FILE.parent.mkdir(parents=True, exist_ok=True)
    with STATE_FILE.open("w", encoding="utf-8") as f:
        json.dump(state, f, ensure_ascii=False, indent=2)


def _today_str() -> str:
    return datetime.now(TZ).strftime("%Y-%m-%d")


# --- –ì–æ—Ä–æ—Å–∫–æ–ø ---

SEASONS = {
    "winter": {
        "months": (1, 2, 12),
        "phrase": "–ó–∏–º–∞ –¥–∞—ë—Ç —à–∞–Ω—Å –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è –∏ –ø—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è –∫ —Å–µ–±–µ.",
    },
    "spring": {
        "months": (3, 4, 5),
        "phrase": "–í–µ—Å–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –Ω–∞—á–∏–Ω–∞–Ω–∏—è –∏ —Ç—ë–ø–ª—ã–µ –ø–µ—Ä–µ–º–µ–Ω—ã.",
    },
    "summer": {
        "months": (6, 7, 8),
        "phrase": "–õ–µ—Ç–æ —É—Å–∏–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é, —è—Ä–∫–æ—Å—Ç—å –∏ —Å–º–µ–ª—ã–µ —Ä–µ—à–µ–Ω–∏—è.",
    },
    "autumn": {
        "months": (9, 10, 11),
        "phrase": "–û—Å–µ–Ω—å –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –Ω–∞—á–∞—Ç–æ–µ.",
    },
}

DAY_TYPES = [
    ("–ª—ë–≥–∫–∏–π –¥–µ–Ω—å", "–î–µ–Ω—å –æ–±–µ—â–∞–µ—Ç –±—ã—Ç—å –ª—ë–≥–∫–∏–º –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–º."),
    ("–≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å", "–≠–Ω–µ—Ä–≥–∏–∏ –¥–Ω—è –º—è–≥–∫–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ç–µ–±—è."),
    ("—Å–∏–ª—å–Ω—ã–π –¥–µ–Ω—å", "–î–µ–Ω—å –∑–∞—Ä—è–∂–µ–Ω —Å–∏–ª–æ–π ‚Äî –≥–ª–∞–≤–Ω–æ–µ, –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –µ—ë –≤ –Ω—É–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É."),
]

LOVE_PHRASES = [
    "–¢—ë–ø–ª—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä –ø–æ–º–æ–∂–µ—Ç –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É.",
    "–°—Ç–∞—Ä–∞–π—Å—è –≥–æ–≤–æ—Ä–∏—Ç—å —á–µ—Å—Ç–Ω–æ –∏ –º—è–≥–∫–æ ‚Äî —ç—Ç–æ —Å–±–ª–∏–∑–∏—Ç.",
    "–ù–µ–±–æ–ª—å—à–æ–π —Å–æ–≤–º–µ—Å—Ç–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ –≤–µ—á–µ—Ä —É–ª—É—á—à–∏—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.",
    "–ù–∞–±–ª—é–¥–∞–π –∑–∞ –º–µ–ª–æ—á–∞–º–∏ ‚Äî –≤ –Ω–∏—Ö —Å–µ–≥–æ–¥–Ω—è –æ—Å–æ–±–µ–Ω–Ω–æ –º–Ω–æ–≥–æ –∑–∞–±–æ—Ç—ã.",
]

WORK_PHRASES = [
    "–ù–µ —Å–ø–µ—à–∏ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–∏–Ω–µ—Å—ë—Ç –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
    "–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏ –¥–æ–≤–µ–¥–∏ –µ–≥–æ –¥–æ –∫–æ–Ω—Ü–∞.",
    "–ö–æ—Ä–æ—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –ø–æ–º–æ–∂–µ—Ç –Ω–∞–≤–µ—Å—Ç–∏ –ø–æ—Ä—è–¥–æ–∫ –≤ –¥–µ–ª–∞—Ö.",
    "–ö–æ–ª–ª–µ–≥–∏ —Å–µ–≥–æ–¥–Ω—è –æ—Å–æ–±–µ–Ω–Ω–æ –≤–æ—Å–ø—Ä–∏–∏–º—á–∏–≤—ã –∫ —Å–ø–æ–∫–æ–π–Ω–æ–º—É —Ç–æ–Ω—É.",
]

MONEY_PHRASES = [
    "–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –º–µ–ª–∫–∏–µ —Ç—Ä–∞—Ç—ã ‚Äî –≤ —Å—É–º–º–µ –æ–Ω–∏ –æ—â—É—Ç–∏–º—ã.",
    "–°–∫–∏–¥–∫–∞ –∏–ª–∏ —É–¥–∞—á–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å—Å—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ.",
    "–°–æ—Ö—Ä–∞–Ω—è–π –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å –≤ –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã—Ö –ø–æ–∫—É–ø–∫–∞—Ö.",
    "–ù–µ–±–æ–ª—å—à–∞—è —ç–∫–æ–Ω–æ–º–∏—è —Å–µ–≥–æ–¥–Ω—è –æ–±–ª–µ–≥—á–∏—Ç –ø–ª–∞–Ω—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞.",
]

HEALTH_PHRASES = [
    "–°–¥–µ–ª–∞–π –ø–∞—É–∑—É –¥–ª—è –æ—Ç–¥—ã—Ö–∞ ‚Äî —Ç–µ–ª–æ —Å–∫–∞–∂–µ—Ç —Å–ø–∞—Å–∏–±–æ.",
    "–ü–æ–¥–¥–µ—Ä–∂–∏ –æ—Ä–≥–∞–Ω–∏–∑–º –≤–æ–¥–æ–π –∏ —Å–ø–æ–∫–æ–π–Ω—ã–º —Å–Ω–æ–º.",
    "–ö–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ —É–ª—É—á—à–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.",
    "–°—Ç–∞—Ä–∞–π—Å—è –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ–±—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –¥–µ–ª–∞–º–∏.",
]

ADVICE_PHRASES = [
    "–°–¥–µ–ª–∞–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É —Ç–æ–≥–æ, –æ —á—ë–º –¥–∞–≤–Ω–æ –¥—É–º–∞–µ—à—å.",
    "–ù–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–π —Å–µ–±—è —Å –¥—Ä—É–≥–∏–º–∏ ‚Äî —É —Ç–µ–±—è —Å–≤–æ–π —Ç–µ–º–ø.",
    "–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ, —á—Ç–æ –¥–∞—ë—Ç—Å—è –ª–µ–≥–∫–æ ‚Äî —ç—Ç–æ —Ç–≤–æ—è –æ–ø–æ—Ä–∞.",
    "–ü–æ–¥–¥–µ—Ä–∂–∏ —Ç–æ–≥–æ, –∫—Ç–æ —Ä—è–¥–æ–º ‚Äî —ç—Ç–æ –≤–µ—Ä–Ω—ë—Ç—Å—è –∫ —Ç–µ–±–µ.",
]

DAY_COLORS = [
    ("—è–Ω—Ç–∞—Ä–Ω—ã–π", 2),
    ("–Ω–µ–±–µ—Å–Ω–æ-–≥–æ–ª—É–±–æ–π", 3),
    ("–∏–∑—É–º—Ä—É–¥–Ω—ã–π", 4),
    ("–ª–∞–≤–∞–Ω–¥–æ–≤—ã–π", 5),
    ("–º—è–≥–∫–∏–π –ø–µ—Ä—Å–∏–∫–æ–≤—ã–π", 6),
    ("–≥—Ä–∞—Ñ–∏—Ç–æ–≤—ã–π", 7),
    ("–æ–ª–∏–≤–∫–æ–≤—ã–π", 8),
]

# --- –¢–∞—Ä–æ (–±–µ–∑ ¬´—Ç—ë–º–Ω—ã—Ö¬ª –∫–∞—Ä—Ç: –¥—å—è–≤–æ–ª, —Å–º–µ—Ä—Ç—å, —Å—É–¥, –±–∞—à–Ω—è –∏ —Ç.–¥.) ---

TAROT_CARDS = [
    {
        "name": "–®—É—Ç",
        "meaning": "–≠–Ω–µ—Ä–≥–∏—è –Ω–∞—á–∞–ª–∞, –ª—ë–≥–∫–æ—Å—Ç–∏ –∏ –¥–æ–≤–µ—Ä–∏—è –∫ –∂–∏–∑–Ω–∏. –•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–≥ –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–≥–æ —Å—Ç—Ä–∞—Ö–∞.",
    },
    {
        "name": "–ú–∞–≥",
        "meaning": "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —Ñ–æ–∫—É—Å –∏ —É–º–µ–Ω–∏–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–∏—Ç—É–∞—Ü–∏–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –∏ –Ω–∞–≤—ã–∫–∏ ‚Äî —É —Ç–µ–±—è –µ—Å—Ç—å –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ.",
    },
    {
        "name": "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞",
        "meaning": "–£—é—Ç, –∑–∞–±–æ—Ç–∞ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ. –•–æ—Ä–æ—à–æ —É–¥–µ–ª–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –¥–æ–º—É, –≤–Ω–µ—à–Ω–µ–º—É –≤–∏–¥—É –∏ –ø—Ä–∏—è—Ç–Ω—ã–º –º–µ–ª–æ—á–∞–º.",
    },
    {
        "name": "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä",
        "meaning": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ø–æ—Ä—è–¥–æ–∫. –î–µ–Ω—å, –∫–æ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ –Ω–∞–≤–µ—Å—Ç–∏ —Ä–∞–º–∫–∏ –≤ –¥–µ–ª–∞—Ö –∏ —Å–ø–æ–∫–æ–π–Ω–æ –æ—Ç—Å—Ç–æ—è—Ç—å —Å–≤–æ–∏ –≥—Ä–∞–Ω–∏—Ü—ã.",
    },
    {
        "name": "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç",
        "meaning": "–¢—Ä–∞–¥–∏—Ü–∏–∏ –∏ –æ–ø—ã—Ç. –ü—Ä–∏—Å–ª—É—à–∞–π—Å—è –∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º —Å–æ–≤–µ—Ç–∞–º –∏–ª–∏ –∫ —á–µ–ª–æ–≤–µ–∫—É, –∫–æ—Ç–æ—Ä–æ–º—É –¥–æ–≤–µ—Ä—è–µ—à—å.",
    },
    {
        "name": "–í–ª—é–±–ª—ë–Ω–Ω—ã–µ",
        "meaning": "–í—ã–±–æ—Ä —Å–µ—Ä–¥—Ü–µ–º –∏ –≤–∞–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–µ. –ì–ª–∞–≤–Ω–æ–µ ‚Äî —á–µ—Å—Ç–Ω–æ—Å—Ç—å —Å —Å–æ–±–æ–π.",
    },
    {
        "name": "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞",
        "meaning": "–î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥—Ä–∞–π–≤. –•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å —Ç–æ, —á—Ç–æ –¥–∞–≤–Ω–æ —Å–æ–±–∏—Ä–∞–ª—Å—è —Å–¥–µ–ª–∞—Ç—å.",
    },
    {
        "name": "–°–∏–ª–∞",
        "meaning": "–¢–∏—Ö–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å. –ú—è–≥–∫–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –æ–∫–∞–∂–µ—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ –¥–∞–≤–ª–µ–Ω–∏—è.",
    },
    {
        "name": "–ó–≤–µ–∑–¥–∞",
        "meaning": "–ù–∞–¥–µ–∂–¥–∞, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –∏ –æ—â—É—â–µ–Ω–∏–µ, —á—Ç–æ –≤—Å—ë –∏–¥—ë—Ç –∫ –ª—É—á—à–µ–º—É. –ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –ø–æ–º–µ—á—Ç–∞—Ç—å.",
    },
    {
        "name": "–°–æ–ª–Ω—Ü–µ",
        "meaning": "–†–∞–¥–æ—Å—Ç—å, —è—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç—ã–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è. –°—Ç–æ–∏—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤—Ä–µ–º—è —Å —Ç–µ–º–∏, –∫—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è —Å—á–∞—Å—Ç–ª–∏–≤–µ–µ.",
    },
    {
        "name": "–ú–∏—Ä",
        "meaning": "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ –∏ –æ—â—É—â–µ–Ω–∏–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏. –•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç –ø–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏ –∏ –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å —Å–µ–±—è.",
    },
]


def _detect_season_phrase(now: datetime) -> str:
    month = now.month
    for data in SEASONS.values():
        if month in data["months"]:
            return data["phrase"]
    return ""


def _ensure_state_structure(state: Dict[str, Any]) -> Dict[str, Any]:
    state.setdefault("horoscopes", {})
    state.setdefault("history", {})
    state.setdefault("tarot", {})
    return state


def _pick_with_antirepeat(
    sign_key: str,
    state: Dict[str, Any],
    total_variants: int,
    history_depth: int = 14,
) -> int:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –≤–∞—Ä–∏–∞–Ω—Ç–∞, –∏–∑–±–µ–≥–∞—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö history_depth –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∑–Ω–∞–∫–∞.
    """
    history: List[int] = state["history"].get(sign_key, [])
    available = [i for i in range(total_variants) if i not in history]

    if not available:
        # –µ—Å–ª–∏ –≤—Å—ë —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        available = list(range(total_variants))
        history = []

    choice = random.choice(available)
    history.append(choice)
    # —Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ history_depth
    state["history"][sign_key] = history[-history_depth:]
    return choice


def generate(sign: str) -> str:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–æ—Ä–æ—Å–∫–æ–ø–∞.

    ‚úÖ –î–ª—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –∑–Ω–∞–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –¥–Ω—è (Europe/Madrid)
       –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –û–î–ò–ù –∏ —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    ‚úÖ –ê–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä –Ω–∞ 14 –¥–Ω–µ–π –ø–æ —à–∞–±–ª–æ–Ω—É (—á–µ—Ä–µ–∑ history).
    """
    sign = sign.strip().title()
    if sign not in ZODIAC_SIGNS:
        raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞: {sign}")

    state = _ensure_state_structure(_load_state())
    today = _today_str()
    sign_key = sign.lower()

    # –ï—Å–ª–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –¥–ª—è —ç—Ç–æ–≥–æ –∑–Ω–∞–∫–∞ —É–∂–µ –µ—Å—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    day_horoscopes = state["horoscopes"].setdefault(today, {})
    if sign_key in day_horoscopes:
        return day_horoscopes[sign_key]["text"]

    now = datetime.now(TZ)

    # –¢–∏–ø –¥–Ω—è —Å –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä–æ–º
    day_type_idx = _pick_with_antirepeat(
        sign_key,
        state,
        total_variants=len(DAY_TYPES),
    )
    day_type_name, day_type_phrase = DAY_TYPES[day_type_idx]

    love = random.choice(LOVE_PHRASES)
    work = random.choice(WORK_PHRASES)
    money = random.choice(MONEY_PHRASES)
    health = random.choice(HEALTH_PHRASES)
    advice = random.choice(ADVICE_PHRASES)

    color, number = random.choice(DAY_COLORS)
    season_phrase = _detect_season_phrase(now)

    text = (
        f"‚ú® –ü—Ä–∏–≤–µ—Ç! –¢–≤–æ–π –∑–Ω–∞–∫: {sign}\n"
        f"–°–µ–≥–æ–¥–Ω—è ‚Äî {day_type_name}.\n\n"
        f"üíñ –õ—é–±–æ–≤—å: {love}\n"
        f"üíº –†–∞–±–æ—Ç–∞: {work}\n"
        f"üí∞ –î–µ–Ω—å–≥–∏: {money}\n"
        f"üåø –ó–¥–æ—Ä–æ–≤—å–µ: {health}\n"
        f"üéØ –°–æ–≤–µ—Ç: {advice}\n"
        f"#Ô∏è‚É£ –ß–∏—Å–ª–æ –¥–Ω—è: {number}\n"
        f"üé® –¶–≤–µ—Ç –¥–Ω—è: {color}\n\n"
        f"üå± –°–µ–∑–æ–Ω–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç: {season_phrase}"
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º, —á—Ç–æ–±—ã –¥–ª—è –≤—Å–µ—Ö –õ—å–≤–æ–≤/–û–≤–Ω–æ–≤ –∏ —Ç.–¥. –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å —Ç–µ–∫—Å—Ç –±—ã–ª –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π
    day_horoscopes[sign_key] = {
        "text": text,
        "day_type_idx": day_type_idx,
    }
    state["horoscopes"][today] = day_horoscopes
    _save_state(state)

    return text


# --- –¢–∞—Ä–æ ---


def draw_tarot_for_user(user_id: Any) -> dict:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Ä—Ç—É –¢–∞—Ä–æ –¥–Ω—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    ‚úÖ –ù–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–π –ù–û–í–û–ô –∫–∞—Ä—Ç—ã –≤ —Å—É—Ç–∫–∏ –Ω–∞ user_id.
    –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å:
      ‚Ä¢ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç—É –∂–µ –∫–∞—Ä—Ç—É
      ‚Ä¢ —Å—Ç–∞–≤–∏—Ç already_drawn=True (–±–æ—Ç –ø–æ —ç—Ç–æ–º—É —Ñ–ª–∞–≥—É –º–æ–∂–µ—Ç –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—ã–±–æ—Ä –∫–∞—Ä—Ç).
    """
    state = _ensure_state_structure(_load_state())
    today = _today_str()
    user_key = str(user_id)

    day_tarot = state["tarot"].setdefault(today, {})

    if user_key in day_tarot:
        # —É–∂–µ —Ç—è–Ω—É–ª–∏ —Å–µ–≥–æ–¥–Ω—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç—É –∂–µ –∫–∞—Ä—Ç—É
        data = day_tarot[user_key]
        return {
            "text": data["text"],
            "card": data["card"],
            "already_drawn": True,
        }

    card = random.choice(TAROT_CARDS)
    text = f"üîÆ –¢–∞—Ä–æ –¥–Ω—è: {card['name']}\n\n{card['meaning']}"

    payload = {
        "card": card["name"],
        "text": text,
    }
    day_tarot[user_key] = payload
    state["tarot"][today] = day_tarot
    _save_state(state)

    return {
        "text": text,
        "card": card["name"],
        "already_drawn": False,
    }


# –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:
def generate_tarot(user_id: Any) -> str:
    """
    –ö–æ—Ä–æ—Ç–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç—ã.

    –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å, —Ç—è–Ω—É–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∫–∞—Ä—Ç—É —Å–µ–≥–æ–¥–Ω—è,
    –∏—Å–ø–æ–ª—å–∑—É–π draw_tarot_for_user(user_id) –∏ —Å–º–æ—Ç—Ä–∏ –ø–æ–ª–µ already_drawn.
    """
    result = draw_tarot_for_user(user_id)
    return result["text"]
