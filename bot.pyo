7882595325:AAHyrxDf_4nDiy_8LspmkVJHHL-KoRKzhbccat > bot.py << 'PY'
import os, logging
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, ContextTypes, filters
from generator import generate, STYLES, SIGNS

logging.basicConfig(level=logging.INFO)
VERSION = "Astro v2"

TOKEN = "7882595325:AAHyrxDf_4nDiy_8LspmkVJHHL-KoRKzhbc"  # ‚Üê –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω!

user_prefs = {}  # user_id -> {"sign":"aries","style":"classic","lang":"ru"}

def kb_signs():
    rows = [
        [("‚ôà","aries"),("‚ôâ","taurus"),("‚ôä","gemini")],
        [("‚ôã","cancer"),("‚ôå","leo"),("‚ôç","virgo")],
        [("‚ôé","libra"),("‚ôè","scorpio"),("‚ôê","sagittarius")],
        [("‚ôë","capricorn"),("‚ôí","aquarius"),("‚ôì","pisces")],
    ]
    return InlineKeyboardMarkup([
        [InlineKeyboardButton(txt, callback_data=f"set_sign:{val}") for txt,val in row] for row in rows
    ])

def kb_styles():
    mapping = [("–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π","classic"),("–Æ–º–æ—Ä–Ω–æ–π","humor"),("–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π","mystic"),("–ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π","motivation")]
    return InlineKeyboardMarkup([[InlineKeyboardButton(n, callback_data=f"set_style:{k}")] for n,k in mapping])

def fmt(h):
    return (
        f"*{h.get('title','')}* ¬∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: _{h.get('mood','')}_\n"
        f"üíñ –õ—é–±–æ–≤—å: {h.get('love','')}\n"
        f"üíº –†–∞–±–æ—Ç–∞: {h.get('work','')}\n"
        f"üí∞ –î–µ–Ω—å–≥–∏: {h.get('money','')}\n"
        f"üåø –ó–¥–æ—Ä–æ–≤—å–µ: {h.get('health','')}\n"
        f"üéØ –°–æ–≤–µ—Ç: {h.get('advice','')}\n"
        f"#Ô∏è‚É£ –ß–∏—Å–ª–æ –¥–Ω—è: {h.get('lucky_number','?')}   üé® –¶–≤–µ—Ç: {h.get('lucky_color','?')}\n"
        f"üéµ –¢—Ä–µ–∫ –¥–Ω—è: {h['song'].get('title','')} ‚Äî {h['song'].get('url','')}\n"
        f"_{VERSION}_"
    )

async def ping(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(f"pong {VERSION}")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    user_prefs.setdefault(uid, {"sign":"aries","style":"classic","lang":"ru"})
    await update.message.reply_text(
        f"–ü—Ä–∏–≤–µ—Ç! –Ø –∞—Å—Ç—Ä–æ–±–æ—Ç üí´ ({VERSION})\n–í—ã–±–µ—Ä–∏ —Å–≤–æ–π –∑–Ω–∞–∫:",
        reply_markup=kb_signs()
    )

async def today(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    prefs = user_prefs.setdefault(uid, {"sign":"aries","style":"classic","lang":"ru"})
    logging.info(f"[{VERSION}] today for uid={uid} sign={prefs['sign']} style={prefs['style']} lang={prefs['lang']}")
    h = generate(prefs["sign"], prefs["style"], prefs["lang"])
    await update.message.reply_markdown(fmt(h))

async def style_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–í—ã–±–µ—Ä–∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:", reply_markup=kb_styles())

async def lang_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    lang = (context.args[0] if context.args else "ru").lower()
    if lang not in ("ru","en","es"): lang = "ru"
    user_prefs.setdefault(uid, {"sign":"aries","style":"classic","lang":"ru"})
    user_prefs[uid]["lang"] = lang
    await update.message.reply_text(f"–Ø–∑—ã–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {lang.upper()}")

async def on_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    txt = (update.message.text or "").strip().lower()
    logging.info(f"[{VERSION}] text from uid={uid}: {txt!r}")
    if txt in SIGNS:
        prefs = user_prefs.setdefault(uid, {"sign":"aries","style":"classic","lang":"ru"})
        prefs["sign"] = txt
        h = generate(txt, prefs["style"], prefs["lang"])
        await update.message.reply_markdown(fmt(h))
    else:
        await update.message.reply_text(
            "–ù–∞–ø–∏—à–∏ –∑–Ω–∞–∫ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, *leo*, *aries*) –∏–ª–∏ –Ω–∞–∂–º–∏ /start",
            parse_mode="Markdown"
        )

async def on_cb(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    uid = q.from_user.id
    data = q.data or ""
    prefs = user_prefs.setdefault(uid, {"sign":"aries","style":"classic","lang":"ru"})
    logging.info(f"[{VERSION}] callback: {data}")
    if data.startswith("set_sign:"):
        sign = data.split(":",1)[1]
        if sign in SIGNS:
            prefs["sign"] = sign
            await q.edit_message_text(f"–ó–Ω–∞–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {sign.capitalize()}\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ —Ç–æ–Ω:", reply_markup=kb_styles())
        else:
            await q.edit_message_text("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∑–Ω–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
    elif data.startswith("set_style:"):
        style = data.split(":",1)[1]
        if style in STYLES:
            prefs["style"] = style
            await q.edit_message_text(f"–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {STYLES[style]}\n–ù–∞–∂–º–∏ /today –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.")
        else:
            await q.edit_message_text("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∏–ª—å.")

def main():
    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("ping", ping))
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("today", today))
    app.add_handler(CommandHandler("style", style_cmd))
    app.add_handler(CommandHandler("lang", lang_cmd))  # /lang ru | en | es
    app.add_handler(CallbackQueryHandler(on_cb))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, on_text))
    app.run_polling()

if __name__ == "__main__":
    main()
PY

